import{h as te,r,j as e,D}from"./index-BK3-NH0U.js";import{T as ne,I as ae}from"./Training4-DrRZATOC.js";import{B as p}from"./Box-BMscNp0X.js";import{B as ie,T as l}from"./IconButton-DaRbuSTx.js";import{C as re}from"./CircularProgress-DgHt8u90.js";import{C as oe,a as le,D as M}from"./CardContent-BVQLvcW_.js";import{G as g}from"./Grid-BdJHifXQ.js";import{T as W,F as P}from"./TextField-B7uaY3nt.js";import{B as q}from"./Button-5xkrV6ZK.js";import{F as x}from"./FormControlLabel-EEnyw3xy.js";import{C as _}from"./Checkbox-QoR1bMJy.js";import"./createSvgIcon-DOtjgECc.js";import"./TableRow-oYFPfLxG.js";import"./dividerClasses-BYNFPXcK.js";import"./styled-DIuUJDu6.js";const Pe=()=>{const V=te(t=>t.userInfo),[c,w]=r.useState({TOOLS:!1,PPE:!1,DRESS:!1}),[T,U]=r.useState([]),[C,z]=r.useState([]),[O,$]=r.useState([]),[y,I]=r.useState(new Date().toISOString().split("T")[0]),[f,G]=r.useState(""),[R,ce]=r.useState(V.whitelevel_id),[v,L]=r.useState(""),[j,B]=r.useState([]),[o,S]=r.useState({}),[E,b]=r.useState(!1),[N,A]=r.useState(""),[m,J]=r.useState({tools:[],ppes:[],dresses:[]});r.useState({option1:!1}),r.useState({}),r.useEffect(()=>{(async()=>{try{const s=(await D.get("/item/getAll/")).data,n=s.filter(h=>h.item_type.item_type_name==="Tool"),u=s.filter(h=>h.item_type.item_type_name==="PPE"),d=s.filter(h=>h.item_type.item_type_name==="Dress");J({tools:n,ppes:u,dresses:d})}catch(a){console.error("Error fetching items:",a)}})()},[]);const Y=async t=>{if(t.target,!f){alert("Issuance ID is required to fetch details.");return}try{const s=(await D.post("/item/get-details/",{issue_id:f,whitelevel_id:R})).data;if(s){I(s.new_issuance.issuance_date);const n={TOOLS:s.issued_things.some(i=>i.item_type_id==="1"),PPE:s.issued_things.some(i=>i.item_type_id==="2"),DRESS:s.issued_things.some(i=>i.item_type_id==="3")};w(n);const u=s.issued_things.filter(i=>i.item_type_id==="1"),d=s.issued_things.filter(i=>i.item_type_id==="2"),h=s.issued_things.filter(i=>i.item_type_id==="3");J({tools:u,ppes:d,dresses:h}),B(s.issued_to_employees.map(i=>({employee_id:i.employee,employee_name:i.employee_name}))),L(s.new_issuance.newIssuance_image),A(s.new_issuance.about_the_newissuance)}else alert("No issuance data found. Please check the reference number.")}catch(a){console.error("Error fetching issuance data:",a),S({fetch:"Failed to fetch issuance data. Please try again."})}},Z=async t=>{t.preventDefault(),b(!0);const a=[...C.map(n=>({item:n.item})),...T.map(n=>({item:n.item})),...O.map(n=>({item:n.item}))],s={issuance_id:f,whitelevel_id:R,issuance_date:y,newIssuance_image:v,about_the_newissuance:N,issued_things:a,issued_to_employees:j.map(({employee_id:n})=>({employee:n}))};try{const n=await D.put("item/newissuance-update/",s);console.log("Updated NewIssuance:",n.data),alert("Updated NewIssuance:",n.data)}catch(n){console.error("Error:",n),S("An error occurred while updating the accident.")}finally{b(!1)}},F=t=>{const{name:a,checked:s}=t.target;w(n=>({...n,[a]:s}))},k=(t,a)=>{const{name:s,checked:n}=t.target,u=(d,h,i)=>i?[...d,{item:h}]:d.filter(se=>se.item!==h);a==="TOOLS"&&z(d=>u(d,s,n)),a==="PPE"&&U(d=>u(d,s,n)),a==="DRESS"&&$(d=>u(d,s,n))},H=t=>{B(t)},K=t=>{A(t.target.value)},Q=()=>{let t={};y||(t.issuance_date="Issuance date is required");const a=/^[A-Za-z0-9/-]+$/;return f?f.length<3||f.length>21?t.issuance_id="Reference number must be between 3 and 21 characters":a.test(f)||(t.issuance_id="Reference number can only contain letters, numbers, hyphens, and slashes"):t.issuance_id="Reference number is required",c.TOOLS&&C.length===0&&(t.tools="At least one tool must be selected"),c.PPE&&T.length===0&&(t.ppe="At least one PPE must be selected"),c.DRESS&&O.length===0&&(t.dress="At least one dress must be selected"),j.length===0?t.employees="Employee details are required":j.forEach(({employee_id:s,employee_name:n},u)=>{(!s||!n)&&(t.employees=`Employee ID and Name cannot be empty for entry #${u+1}`)}),!c.TOOLS&&!c.PPE&&!c.DRESS&&(t.items="At least one item category must be selected"),S(t),Object.keys(t).length===0},X=()=>{w({TOOLS:!1,PPE:!1,DRESS:!1}),U([]),z([]),$([]),I(new Date().toISOString().split("T")[0]),G(""),L(""),S({}),A(""),B([])},ee=async()=>{if(!Q())return;b(!0);const t=[...C.map(s=>({item:s.item})),...T.map(s=>({item:s.item})),...O.map(s=>({item:s.item}))],a={issuance:{issuance_id:f,white_level_id:R,issuance_date:y,newIssuance_image:v||null,about_the_newissuance:N},issued_things:t,employees:j.map(({employee_id:s,employee_name:n,whitelevel_id:u})=>({employee_id:s,employee_name:n,whitelevel_id:u}))};console.log("Submitting the following data:"),console.log(JSON.stringify(a,null,2));try{const n=(await D.post("/item/new/",a)).data.message;console.log("Data submitted successfully:",n),alert("New Issuance Successfully submitted."),X()}catch(s){console.error("Error submitting data:",s),alert(`Error submitting data: ${s.message}`)}finally{b(!1)}};return e.jsxs(p,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:[e.jsx(ie,{sx:{color:"#fff",zIndex:t=>t.zIndex.drawer+1},open:E,children:e.jsx(re,{color:"inherit"})}),e.jsx(oe,{sx:{width:"100%",padding:3},children:e.jsxs(le,{children:[e.jsxs(g,{container:!0,spacing:2,marginBottom:3,children:[e.jsx(g,{item:!0,xs:12,sm:5.5,children:e.jsx(W,{label:"Date*",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:y,onChange:t=>I(t.target.value),error:!!o.issuance_date,helperText:o.issuance_date})}),e.jsx(g,{item:!0,xs:12,sm:5.5,children:e.jsx(W,{label:"Reference Number*",fullWidth:!0,value:f,onChange:t=>G(t.target.value),error:!!o.issuance_id,helperText:o.issuance_id})}),e.jsx(g,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},kk:!0,children:e.jsx(q,{variant:"contained",color:"secondary",onClick:Y,fullWidth:!0,disabled:E,children:"ok"})})]}),e.jsx(M,{sx:{marginBottom:3}}),e.jsx(l,{variant:"h6",children:"Items*:"}),o.items&&e.jsx(l,{color:"error",children:o.items}),e.jsx(x,{control:e.jsx(_,{checked:c.TOOLS,onChange:F,name:"TOOLS"}),label:"TOOLS"}),e.jsx(x,{control:e.jsx(_,{checked:c.PPE,onChange:F,name:"PPE"}),label:"PPE"}),e.jsx(x,{control:e.jsx(_,{checked:c.DRESS,onChange:F,name:"DRESS"}),label:"DRESS"}),c.TOOLS&&e.jsxs(p,{marginBottom:3,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(l,{variant:"h6",children:"TOOLS"}),((m==null?void 0:m.tools)??[]).length>0?e.jsx(p,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((t,a)=>e.jsx(p,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:a<3?2:0,marginBottom:2,children:m.tools.slice(a*10,(a+1)*10).map(s=>e.jsx(x,{control:e.jsx(_,{onChange:n=>k(n,"TOOLS"),name:s.item_id}),label:s.item_name},s.item_id))},a))}):e.jsx(l,{children:"Loading tools..."})]}),o.tools&&e.jsx(l,{color:"error",children:o.tools})]}),c.PPE&&e.jsxs(p,{marginBottom:3,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(l,{variant:"h6",children:"PPE"}),((m==null?void 0:m.ppes)??[]).length>0?e.jsx(p,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((t,a)=>e.jsx(p,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:a<3?2:0,marginBottom:2,children:m.ppes.slice(a*10,(a+1)*10).map(s=>e.jsx(x,{control:e.jsx(_,{onChange:n=>k(n,"PPE"),name:s.item_id}),label:s.item_name},s.item))},a))}):e.jsx(l,{children:"Loading PPE..."})]}),o.ppe&&e.jsx(l,{color:"error",children:o.ppe})]}),c.DRESS&&e.jsxs(p,{marginBottom:3,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(l,{variant:"h6",children:"DRESS"}),((m==null?void 0:m.dresses)??[]).length>0?e.jsx(p,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((t,a)=>e.jsx(p,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:a<3?2:0,marginBottom:2,children:m.dresses.slice(a*10,(a+1)*10).map(s=>e.jsx(x,{control:e.jsx(_,{onChange:n=>k(n,"DRESS"),name:s.item_id}),label:s.item_name},s.item))},a))}):e.jsx(l,{children:"Loading dresses..."})]}),o.dress&&e.jsx(l,{color:"error",children:o.dress})]}),e.jsx(M,{sx:{marginBottom:3}}),e.jsxs(p,{marginBottom:3,children:[e.jsx(l,{variant:"h6",children:"EMPLOYEE DETAILS*:"}),e.jsx(ne,{onChange:H,initialData:j}),o.employees&&e.jsx(l,{color:"error",children:o.employees})]}),e.jsx(g,{item:!0,xs:12,children:e.jsx(P,{fullWidth:!0,margin:"normal",children:e.jsx(W,{label:"Description....",multiline:!0,rows:4,value:N,onChange:K})})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(ae,{setCompressedImageBase64:L,compressedImageBase64:v})}),e.jsxs(g,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(q,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:E,onClick:ee,children:"Submit"})}),e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(q,{variant:"contained",color:"secondary",onClick:Z,fullWidth:!0,disabled:E,children:"Update NewIssuance"})})]})]})})]})};export{Pe as default};
