import{h as ee,r as m,j as r,D as P}from"./index-D-0L0kqd.js";import{B as re}from"./Box-wRudlJZ-.js";import{T as ue,a as he,b as ge,c as X,d as w,e as fe}from"./TableRow-Bemw0FEp.js";import{P as K,L as ye,I as _e,T as F}from"./IconButton-Nx4_nG5A.js";import{T as q,F as M}from"./TextField-NIFr-SYI.js";import{L as Te,R as xe,a as $}from"./RadioGroup-AN5GqQgt.js";import{D as je,F as be,A as ve,T as Se,I as Ie}from"./Training4-Dda0H0QU.js";import{C as Ce}from"./Container-KasY_20w.js";import{C as De,a as Ee,D as we}from"./CardContent-DpxhflNP.js";import{G as y}from"./Grid-DazL6J-j.js";import{B as Q}from"./Button-DrG4cIXq.js";import{F as z}from"./FormControlLabel-_sfi8U8q.js";import"./createSvgIcon-Com4O_JJ.js";import"./styled-DnMDCR_Z.js";import"./dividerClasses-UAkNZsA2.js";const Y=({onEmployeesChange:A,initialData:_})=>{const R=ee(e=>e.userInfo),[o,T]=m.useState(_||[]),[v,L]=m.useState(R.whitelevel_id),[x,D]=m.useState({}),[E,S]=m.useState({});m.useEffect(()=>{if(Array.isArray(_)&&_.length>0&&o.length===0){console.log("initialData :",_);const e=_.map(t=>({...t}));T(t=>JSON.stringify(t)===JSON.stringify(e)?t:e)}},[_]);const U=async(e,t)=>{try{return(await P.post("/employee/name/",{employee_id:e,whitelevel_id:t})).data.employee_name||""}catch(i){return console.error("Error fetching employee name:",i),""}},B=async e=>{try{return(await P.get(`/employee/search/?nameQuery=${e}`)).data||[]}catch(t){return console.error("Error fetching employee suggestions:",t),[]}};m.useEffect(()=>{A(o.map(e=>({employee:e.employee_id,whitelevel_id:v,employee_id:e.employee_id==="0"?"":e.employee_id,employee_name:e.employee_id==="0"?e.name:e.employee_name,trainer_id:e.employee_id,trainer_name:e.employee_id==="0"?e.name:e.employee_name,trainee_id:e.employee_id==="0"?"":e.employee_id,trainee_name:e.employee_id==="0"?"":e.employee_name})))},[o,A]);const j=e=>/^[a-zA-Z\s.]*$/.test(e),W=()=>{if(o.length===0||o[o.length-1].employee_id&&(o[o.length-1].employee_name||o[o.length-1].name))T([...o,{employee_id:"",whitelevel_id:v,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const t=[...o];o[o.length-1].employee_id||(t[o.length-1].employee_id_error=!0),o[o.length-1].employee_name||o[o.length-1].name||(t[o.length-1].employee_name_error=!0),T(t)}},g=e=>{const t=o.filter((i,p)=>p!==e);T(t)},N=async(e,t)=>{const{name:i,value:p}=t.target,a=[...o];if(i==="employee_name"||i==="name")if(j(p))a[e].invalidCharacterError=!1;else{a[e].invalidCharacterError=!0,T(a);return}if(a[e][i]=p,i==="employee_id")if(a[e].employee_id_error=!1,a[e].error="",p==="0")a[e].employee_name="",a[e].manual=!0,a[e].disableNameField=!1;else{const u=a.some((b,I)=>b.employee_id===p&&I!==e);if(a[e].error=u?"duplicate":"",u)a[e].disableNameField=!0;else{const b=await U(p,v);b?(a[e].employee_name=b,a[e].manual=!1,a[e].disableNameField=!0):(a[e].error="invalid",a[e].employee_name="",a[e].disableNameField=!0)}}else if(i==="employee_name")if(p.length>0)if(a.some((b,I)=>b.employee_name===p&&I!==e))a[e].error="duplicate",a[e].disableIDField=!0;else{const b=await B(p);D(I=>({...I,[e]:b})),S(I=>({...I,[e]:!0})),a[e].disableIDField=!1}else D(u=>({...u,[e]:[]})),S(u=>({...u,[e]:!1}));else a[e].employee_name_error=!1,i==="name"&&o[e].employee_id==="0"&&(a[e].employee_name_error=!1,a[e].error="");T(a)},k=(e,t)=>{const i=[...o];i.some((a,u)=>a.employee_name===t.employee_name&&u!==e)?(i[e].error="duplicate",i[e].employee_id_error=!0,i[e].employee_name=t.employee_name,i[e].employee_id="",i[e].disableIDField=!0):(i[e].employee_name=t.employee_name,i[e].employee_id=t.employee_id,i[e].manual=!1,i[e].error="",i[e].employee_id_error=!1,i[e].disableIDField=!1),D(a=>({...a,[e]:[]})),S(a=>({...a,[e]:!1})),T(i)},O=e=>{setTimeout(()=>{S(t=>({...t,[e]:!1}))},200)};return r.jsxs(re,{sx:{position:"relative"},children:[r.jsx(ue,{component:K,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:r.jsxs(he,{children:[r.jsx(ge,{children:r.jsxs(X,{children:[r.jsx(w,{children:"Sl. No"}),r.jsx(w,{sx:{pl:12},children:"Employee ID"}),r.jsx(w,{sx:{pl:12},children:"Employee Name"}),r.jsx(w,{sx:{pl:2},children:"Actions"})]})}),r.jsx(fe,{children:o.map((e,t)=>r.jsxs(X,{children:[r.jsx(w,{children:t+1}),r.jsx(w,{children:r.jsx(q,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id,onChange:i=>N(t,i),fullWidth:!0,required:!0,error:!!e.error||e.employee_id_error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.employee_id_error?"Employee ID is required":"",disabled:e.disableIDField,onFocus:()=>S(i=>({...i,[t]:!1}))})}),r.jsxs(w,{children:[r.jsx(q,{variant:"outlined",size:"small",name:e.manual?"name":"employee_name",value:e.manual?e.name:e.employee_name,onChange:i=>N(t,i),onBlur:()=>O(t),fullWidth:!0,required:!0,disabled:e.disableNameField,error:e.employee_name_error||e.invalidCharacterError,helperText:e.invalidCharacterError?"Invalid characters in employee name":e.employee_name_error?"Employee name is required":""}),E[t]&&x[t]&&r.jsx(K,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:r.jsx(ye,{sx:{maxHeight:200,overflow:"auto"},children:x[t].map((i,p)=>r.jsx(Te,{button:!0,onClick:()=>k(t,i),children:`${i.employee_name}`},p))})})]}),r.jsx(w,{children:r.jsx(_e,{color:"primary",onClick:()=>g(t),children:r.jsx(je,{})})})]},t))})]})}),r.jsx(be,{color:"primary",size:"small",onClick:W,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:r.jsx(ve,{})})]})},Ge=()=>{const A=ee(s=>s.userInfo),[_,R]=m.useState(A.whitelevel_id),[o,T]=m.useState(new Date().toISOString().split("T")[0]),[v,L]=m.useState(""),[x,D]=m.useState("4"),[E,S]=m.useState(""),[U,B]=m.useState(!1),[j,W]=m.useState([]),[g,N]=m.useState([]),[k,O]=m.useState(""),[e,t]=m.useState(!1),[i,p]=m.useState("");m.useState({option1:!1});const[a,u]=m.useState({trainingDate:"",trainingId:"",whitelevelId:"",trainingType:"",trainingName:"",trainers:"",trainees:"",image:"",about_the_training:""}),[b,I]=m.useState(!1),J=(s,l)=>{const n=s.map(h=>h.trainer_id),c=l.map(h=>h.trainee_id);return n.filter(h=>c.includes(h)).length>0},G=g&&g.length>0?[...g]:[],H=j&&j.length>0?[...j]:[];m.useEffect(()=>{console.log("UpdatedTrainees:",G),console.log("UpdatedTrainers:",H)},[G,H]);const ae=async s=>{if(s.target,!!v){t(!0),t(!0);try{const l=await P.post("/training/training-details/",{training_id:v,whitelevel_id:_}),n=l.data;n?(T(n.training_date),D(n.training_type),S(n.training_name),W(n.trainers.map(c=>({employee_id:c.employee_id,employee_name:c.trainer_name}))),N(n.trainees.map(c=>({employee_id:c.employee_id,employee_name:c.trainee_name}))),O(n.training_image),p(n.about_the_training)):alert("No SafetyTraining data found. Please check the reference number."),console.log("Fetched data:",l.data)}catch(l){console.error("Error fetching accident data:",l),u({fetch:"Failed to fetch accident data. Please try again."})}finally{t(!1)}}},Z=(s,l)=>{let n={...a};if(s==="trainers"&&(W(l),b)){let c=[],f=!1;if(l.forEach((h,d)=>{h.trainer_id!=="0"&&(!h.trainer_id||!h.trainer_name)&&(c.push(`Trainer ${d+1} has empty fields.`),f=!0)}),f){n.trainers=c.join(" "),u(n);return}J(l,g)?(n.trainers="Trainer and Trainee employee codes should not be equal",n.trainees="Trainer and Trainee employee codes should not be equal"):(n.trainers="",n.trainees="")}if(s==="trainees"&&(N(l),b)){let c=[],f=!1;if(l.forEach((h,d)=>{h.trainee_id!=="0"&&(!h.trainee_id||!h.trainee_name)&&(c.push(`Trainee ${d+1} has empty fields.`),f=!0)}),f){n.trainees=c.join(" "),u(n);return}J(j,l)?(n.trainers="Trainer and Trainee employee codes should not be equal",n.trainees="Trainer and Trainee employee codes should not be equal"):(n.trainers="",n.trainees="")}},te=s=>{R(s.target.value)},ne=s=>{T(s.target.value)},ie=s=>{const l=s.target.value;D(l),B(l==="1"),u({...a,trainingType:l===""?"Training Type is required":""})},se=s=>{const l=s.target.value,n=/^[A-Za-z\s]*$/;S(l),x==="1"&&(n.test(l)?u({...a,trainingName:""}):u({...a,trainingName:"Training Name must contain only alphabets and spaces"}))},le=s=>{L(s.target.value)},oe=s=>{p(s.target.value)},de=new Date().toISOString().split("T")[0],me=()=>{R(A.whitelevel_id),T(new Date().toISOString().split("T")[0]),L(""),D("4"),S(""),B(!1),W([]),N([]),O(""),p("")},ce=async s=>{var f,h;s.preventDefault(),t(!0),I(!0);let l=!0;const n={trainingDate:o?"":"Training Date is required",trainingId:v?"":"Training ID is required",whitelevelId:_?"":"Whitelevel ID is required",trainingType:x?"":"Training Type is required",trainingName:x==="1"&&!E?"Training Name is required":"",trainers:j.length===0?"At least one Trainer is required":"",trainees:g.length===0?"At least one Trainee is required":""};if(x==="1"&&(E?/^[A-Za-z\s]*$/.test(E)||(n.trainingName="Training Name must contain only alphabets and spaces",l=!1):(n.trainingName="Training Name is required",l=!1)),Object.keys(n).forEach(d=>{n[d]&&(l=!1)}),j.forEach((d,C)=>{d.trainer_id!=="0"&&(!d.trainer_id||!d.trainer_name)&&(n[`trainer_${C}_name`]="Trainer name is required",l=!1)}),g.forEach((d,C)=>{d.trainee_id!=="0"&&(!d.trainee_id||!d.trainee_name)&&(n[`trainee_${C}_name`]="Trainee name is required",l=!1)}),J(j,g)&&(n.trainers="Trainer and Trainee employee codes should not be equal",n.trainees="Trainer and Trainee employee codes should not be equal",l=!1),u(n),!l){t(!1);return}const c={training_id:v,training_date:o,whitelevel_id:_,training_type:x,training_image:k,about_the_training:i,training_name:x==="1"?E:null,trainers:j.map(({trainer_id:d,whitelevel_id:C,trainer_name:V})=>({trainer_id:d,whitelevel_id:C,trainer_name:V})),trainees:g.map(({trainee_id:d,trainee_name:C,whitelevel_id:V})=>({trainee_id:d,whitelevel_id:V,trainee_name:C}))};console.log("Submitting the following data:"),console.log(JSON.stringify(c,null,2));try{const d=await P.post("/training/start/",c);console.log("Success:",d.data),window.alert("Safety Training Form submitted successfully!"),me(),R(A.whitelevel_id),T(new Date().toISOString().split("T")[0]),L(""),D("4"),S(""),B(!1),W([]),N([]),O(""),p("")}catch(d){if(d.response){console.error(`HTTP error! Status: ${d.response.status}`);const C=JSON.stringify(d.response.data);console.error("Response body:",C),((h=(f=d.response.data)==null?void 0:f.training_id)==null?void 0:h[0])==="training with this training id already exists."?window.alert("Training ID already exists. Please use a different ID."):window.alert("Error submitting form. Please check the details and try again.")}else d.isAxiosError?(console.error("Axios error:",d.message),window.alert("An error occurred with the request. Please try again.")):d.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),window.alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",d.message),window.alert(`Error fetching data: ${d.message}`))}finally{t(!1)}},pe=async s=>{s.preventDefault(),t(!0);const l={training_id:v,training_type:x,training_name:E,whitelevel_id:_,image:k,about_the_training:i,training_image:k,trainers:j.map(({trainer_id:n,whitelevel_id:c,trainer_name:f})=>({employee_id:n,whitelevel_id:c,trainer_name:f})),trainees:g.map(({trainee_id:n,trainee_name:c,whitelevel_id:f})=>({employee_id:n,whitelevel_id:f,trainee_name:c}))};try{const n=await P.put("/training/training-details-update/",l);console.log("Updated Training:",n.data),alert("Updated Training:",n.data)}catch(n){console.error("Error:",n),u("An error occurred while updating the accident.")}finally{t(!1)}};return r.jsx(Ce,{children:r.jsx(re,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:r.jsx("form",{onSubmit:ce,children:r.jsx(De,{sx:{maxwidth:"100%",padding:3,boxShadow:3},children:r.jsx(Ee,{children:r.jsxs(y,{container:!0,spacing:2,children:[r.jsx(y,{item:!0,xs:12,sm:5.5,children:r.jsx(q,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:o,onChange:ne,max:de,error:!!a.trainingDate,helperText:a.trainingDate,required:!0})}),r.jsx(y,{item:!0,xs:12,sm:5.5,children:r.jsx(q,{label:"Reference Number",fullWidth:!0,value:v,onChange:le,error:!!a.trainingId,helperText:a.trainingId})}),r.jsx(y,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},children:r.jsx(Q,{variant:"contained",color:"secondary",onClick:ae,fullWidth:!0,disabled:e,children:"ok"})}),r.jsxs(y,{item:!0,xs:12,children:[r.jsx(F,{variant:"h6",style:{display:"none"},children:"Whitelevel ID:"}),r.jsx(M,{fullWidth:!0,margin:"normal",style:{display:"none"},children:r.jsx(q,{style:{display:"none"},label:"Whitelevel ID",fullWidth:!0,value:_,onChange:te,error:!!a.whitelevelId,helperText:a.whitelevelId})})]}),r.jsxs(y,{item:!0,xs:12,children:[r.jsx(F,{variant:"h6",sx:{marginBottom:1},required:!0,children:"Training Type *:"}),r.jsxs(xe,{row:!0,value:x,onChange:ie,children:[r.jsx(z,{value:"4",control:r.jsx($,{}),label:"Tool box Training"}),r.jsx(z,{value:"3",control:r.jsx($,{}),label:"Job & Safety"}),r.jsx(z,{value:"2",control:r.jsx($,{}),label:"Behavioural"}),r.jsx(z,{value:"1",control:r.jsx($,{}),label:"Others"})]}),U&&r.jsx(q,{label:"Name of Training",fullWidth:!0,value:E,onChange:se,error:!!a.trainingName,helperText:a.trainingName}),a.trainingType&&r.jsx(F,{variant:"body2",color:"error",sx:{mt:1},children:a.trainingType})]}),r.jsxs(y,{item:!0,xs:12,children:[r.jsx(we,{sx:{marginBottom:3}}),r.jsx(F,{variant:"h6",children:"TRAINER *: (Enter 0 in case of Others)"}),Array.isArray(g)&&g.length>0?r.jsx(Y,{onEmployeesChange:s=>Z("trainers",s),error:!!a.trainers,helperText:a.trainers,initialData:H}):r.jsx(Y,{onEmployeesChange:s=>Z("trainers",s),error:!!a.trainers,helperText:a.trainers}),a.trainers&&r.jsx(F,{variant:"body2",color:"error",sx:{mt:1},children:a.trainers})]}),r.jsxs(y,{item:!0,xs:12,children:[r.jsx(F,{variant:"h6",children:"TRAINEE *:"}),r.jsx(Se,{onChange:s=>Z("trainees",s),error:!!a.trainees,helperText:a.trainees,initialData:G}),a.trainees&&r.jsx(F,{variant:"body2",color:"error",sx:{mt:1},children:a.trainees})]}),r.jsx(y,{item:!0,xs:12,children:r.jsx(M,{fullWidth:!0,margin:"normal",children:r.jsx(q,{label:"Description",multiline:!0,rows:4,value:i,onChange:oe})})}),r.jsx(y,{item:!0,xs:12,children:r.jsx(Ie,{setCompressedImageBase64:O,compressedImageBase64:k})}),r.jsxs(y,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[r.jsx(y,{item:!0,xs:12,md:6,children:r.jsx(Q,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:e,children:"Submit"})}),r.jsx(y,{item:!0,xs:12,md:6,children:r.jsx(Q,{variant:"contained",color:"secondary",onClick:pe,fullWidth:!0,disabled:e,children:"Update"})})]})]})})})})})})};export{Ge as default};
