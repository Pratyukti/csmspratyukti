import{h as se,r as d,j as e,D as U}from"./index-ClV15evO.js";import{D as je,F as be,A as ve,I as Se}from"./Delete-rtlks4SK.js";import{B as E}from"./Box-bCNXVwYJ.js";import{T as Ie,a as Ce,b as Te,c as ee,d as w,e as Ee}from"./TableRow-WBDk2Q7z.js";import{P as re,L as we,I as De,T as x,B as ke}from"./IconButton-9uWMncTP.js";import{T as $,F as P,a as L}from"./TextField-Dyqu7dDL.js";import{L as Ne,R as z,a as y}from"./RadioGroup-EMHDKaMR.js";import{T as Re}from"./Training4-CQMNOWHC.js";import{C as Ae}from"./Container-DSFVk6K_.js";import{C as Fe,a as Be,D as Pe}from"./CardContent-B4wlWcKs.js";import{G as h}from"./Grid-CukM0hiV.js";import{B as X}from"./Button-C22GjKN7.js";import{F as _}from"./FormControlLabel-nTT0Z78y.js";import{C as $e}from"./CircularProgress-DuciHHq6.js";import"./createSvgIcon-Bo4oMKsv.js";import"./styled-DJ2ZZm4A.js";import"./dividerClasses-Ce9XUCVp.js";const te=({onEmployeesChange:W,initialData:g})=>{const J=se(r=>r.userInfo),[n,v]=d.useState(g||[]),[C,G]=d.useState(J.whitelevel_id),[S,D]=d.useState({}),[k,T]=d.useState({});d.useEffect(()=>{if(Array.isArray(g)&&g.length>0&&n.length===0){console.log("initialData :",g);const r=g.map(a=>({...a,employee_id:a.trainer_id,employee_name:a.trainer_name}));console.log("Updated Rows:",r),v(r)}},[g]);const j=async(r,a)=>{try{return(await U.post("/employee/name/",{employee_id:r,whitelevel_id:a})).data.employee_name||""}catch(o){return console.error("Error fetching employee name:",o),""}},H=async r=>{try{return(await U.get(`/employee/search/?nameQuery=${r}`)).data||[]}catch(a){return console.error("Error fetching employee suggestions:",a),[]}};d.useEffect(()=>{W(n.map(r=>({employee:r.employee_id,whitelevel_id:C,employee_id:r.employee_id==="0"?"":r.employee_id,employee_name:r.employee_id==="0"?r.name:r.employee_name,trainer_id:r.employee_id,trainer_name:r.employee_id==="0"?r.name:r.employee_name,trainee_id:r.employee_id==="0"?"":r.employee_id,trainee_name:r.employee_id==="0"?"":r.employee_name})))},[n,W]);const N=r=>/^[a-zA-Z\s.]*$/.test(r),q=()=>{if(n.length===0||n[n.length-1].employee_id&&(n[n.length-1].employee_name||n[n.length-1].name))v([...n,{employee_id:"",whitelevel_id:C,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const a=[...n];n[n.length-1].employee_id||(a[n.length-1].employee_id_error=!0),n[n.length-1].employee_name||n[n.length-1].name||(a[n.length-1].employee_name_error=!0),v(a)}},R=r=>{const a=n.filter((o,p)=>p!==r);v(a)},A=async(r,a)=>{const{name:o,value:p}=a.target,l=[...n];if(o==="employee_name"||o==="name")if(N(p))l[r].invalidCharacterError=!1;else{l[r].invalidCharacterError=!0,v(l);return}if(l[r][o]=p,o==="employee_id")if(l[r].employee_id_error=!1,l[r].error="",p==="0")l[r].employee_name="",l[r].manual=!0,l[r].disableNameField=!1;else{const f=l.some((b,I)=>b.employee_id===p&&I!==r);if(l[r].error=f?"duplicate":"",f)l[r].disableNameField=!0;else{const b=await j(p,C);b?(l[r].employee_name=b,l[r].manual=!1,l[r].disableNameField=!0):(l[r].error="invalid",l[r].employee_name="",l[r].disableNameField=!0)}}else if(o==="employee_name")if(p.length>0)if(l.some((b,I)=>b.employee_name===p&&I!==r))l[r].error="duplicate",l[r].disableIDField=!0;else{const b=await H(p);D(I=>({...I,[r]:b})),T(I=>({...I,[r]:!0})),l[r].disableIDField=!1}else D(f=>({...f,[r]:[]})),T(f=>({...f,[r]:!1}));else l[r].employee_name_error=!1,o==="name"&&n[r].employee_id==="0"&&(l[r].employee_name_error=!1,l[r].error="");v(l)},F=(r,a)=>{const o=[...n];o.some((l,f)=>l.employee_name===a.employee_name&&f!==r)?(o[r].error="duplicate",o[r].employee_id_error=!0,o[r].employee_name=a.employee_name,o[r].employee_id="",o[r].disableIDField=!0):(o[r].employee_name=a.employee_name,o[r].employee_id=a.employee_id,o[r].manual=!1,o[r].error="",o[r].employee_id_error=!1,o[r].disableIDField=!1),D(l=>({...l,[r]:[]})),T(l=>({...l,[r]:!1})),v(o)},O=r=>{setTimeout(()=>{T(a=>({...a,[r]:!1}))},200)};return e.jsxs(E,{sx:{position:"relative"},children:[e.jsx(Ie,{component:re,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:e.jsxs(Ce,{children:[e.jsx(Te,{children:e.jsxs(ee,{children:[e.jsx(w,{children:"Sl. No"}),e.jsx(w,{sx:{pl:12},children:"Employee ID"}),e.jsx(w,{sx:{pl:12},children:"Employee Name"}),e.jsx(w,{sx:{pl:2},children:"Actions"})]})}),e.jsx(Ee,{children:n.map((r,a)=>e.jsxs(ee,{children:[e.jsx(w,{children:a+1}),e.jsx(w,{children:e.jsx($,{variant:"outlined",size:"small",name:"employee_id",value:r.employee_id,onChange:o=>A(a,o),fullWidth:!0,required:!0,error:!!r.error||r.employee_id_error,helperText:r.error==="duplicate"?"Duplicate employee ID":r.error==="invalid"?"Employee does not exist":r.employee_id_error?"Employee ID is required":"",disabled:r.disableIDField,onFocus:()=>T(o=>({...o,[a]:!1}))})}),e.jsxs(w,{children:[e.jsx($,{variant:"outlined",size:"small",name:r.manual?"name":"employee_name",value:r.manual?r.name:r.employee_name,onChange:o=>A(a,o),onBlur:()=>O(a),fullWidth:!0,required:!0,disabled:r.disableNameField,error:r.employee_name_error||r.invalidCharacterError,helperText:r.invalidCharacterError?"Invalid characters in employee name":r.employee_name_error?"Employee name is required":""}),k[a]&&S[a]&&e.jsx(re,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:e.jsx(we,{sx:{maxHeight:200,overflow:"auto"},children:S[a].map((o,p)=>e.jsx(Ne,{button:!0,onClick:()=>F(a,o),children:`${o.employee_name}`},p))})})]}),e.jsx(w,{children:e.jsx(De,{color:"primary",onClick:()=>R(a),children:e.jsx(je,{})})})]},a))})]})}),e.jsx(be,{color:"primary",size:"small",onClick:q,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:e.jsx(ve,{})})]})},tr=()=>{const W=se(t=>t.userInfo),[g,J]=d.useState(W.whitelevel_id),[n,v]=d.useState(""),[C,G]=d.useState("false"),[S,D]=d.useState(""),[k,T]=d.useState(new Date().toISOString().split("T")[0]),[j,H]=d.useState(""),[N,q]=d.useState(""),[R,A]=d.useState(""),[F,O]=d.useState(""),[r,a]=d.useState([]),[o,p]=d.useState([]),[l,f]=d.useState([]),[b,I]=d.useState(""),[V,K]=d.useState(""),[Y,B]=d.useState(!1),[We,ae]=d.useState(null);d.useState({option1:!1});const[i,M]=d.useState({accident_report_date:"",accident_id:""}),oe=t=>{I(t.target.value)},le=async t=>{if(t.target,!!j){B(!0);try{const c=await U.post("/accident/accident-detail-get/",{accident_id:j,whitelevel_id:g}),s=c.data;ae(s),s?(T(s.date_of_accident||new Date().toISOString().split("T")[0]),v(s.incident_type||""),A(s.permit_status||""),O(s.ppe_status||""),q(s.severity||""),G(s.toolbox_train||"false"),D(s.toolbox_refno||""),f(s.reported_by||[]),p(s.workmen||[]),a(s.supervisors||[]),I(s.about||""),K(s.accident_image),p(s.workmen.map(m=>({employee_id:m.employee_id||"0",employee_name:m.employee_name||"Others"}))),a(s.supervisors.map(m=>({employee_id:m.employee_id||"0",employee_name:m.employee_name||"Others"}))),f(s.reported_by.map(m=>({employee_id:m.employee_id||"0",employee_name:m.employee_name||"Others"})))):alert("No accident data found. Please check the reference number."),console.log("Fetched data:",c.data)}catch(c){console.error("Error fetching accident data:",c),M({fetch:"Failed to fetch accident data. Please try again."})}finally{B(!1)}}},Q=(t,c)=>{t==="supervisors"&&a(c),t==="workmen"&&p(c),t==="reported_by"&&f(c)},ne=t=>{v(t.target.value)},ie=t=>{G(t.target.value)},ce=t=>{T(t.target.value)},me=t=>{H(t.target.value)},de=t=>{q(t.target.value)},pe=t=>{A(t.target.value)},ue=t=>{O(t.target.value)},he=t=>{D(t.target.value)},ye=()=>{const t={};k||(t.accident_report_date="Date is required"),j?j.length<3||j.length>21?t.accident_id="Reference Number length must be between 3 and 21 characters":/^[a-zA-Z0-9/-]+$/.test(j)?j.startsWith("Acc")||(t.accident_id='Reference Number must start with "Acc"'):t.accident_id="Reference Number can only contain letters, numbers, hyphens (-), and forward slashes (/)":t.accident_id="Reference Number is required",n||(t.accident_type="Incident Type is required"),n==="2"&&(N||(t.severity="Severity is required"),R||(t.permit_status="Permit Status is required"),F||(t.ppe_status="PPE Status is required"),C==="true"&&!S?t.toolbox_reference_number="ToolBox Reference Number is required when Tool Box Talk is Yes":S&&(S.length<3||S.length>21?t.toolbox_reference_number="ToolBox Reference Number length must be between 3 and 21 characters":/^[a-zA-Z0-9/-]+$/.test(S)||(t.toolbox_reference_number="ToolBox Reference Number can only contain letters, numbers, hyphens (-), and forward slashes (/)")));const c=(s,m)=>{m.length===0?t[s]=`${s.replace("_"," ")} is empty`:m.forEach((u,ge)=>{const Z={};u.employee===0||u.employee==="0"||(!u.employee||u.employee.trim()==="")&&(Z.employee_id="Employee ID is required"),(!u.employee_name||u.employee_name.trim()==="")&&(Z.employee_name="Employee Name is required"),Object.keys(Z).length>0&&(t[s]||(t[s]=[]),t[s][ge]=Z)})};return o.length===0&&(t.workmen="Workmen Involved is required"),l.length>0&&c("reported_by",l),o.length>0&&c("workmen",o),r.length>0&&c("supervisors",r),M(t),Object.keys(t).length===0},_e=()=>{J(W.whitelevel_id),v(""),G("false"),D(""),T(new Date().toISOString().split("T")[0]),H(""),q(""),A(""),O(""),a([]),p([]),f([]),I(""),K("")},fe=async t=>{if(t.preventDefault(),!ye())return;B(!0);const c={accident_reporting_date:k,accident_id:j,accident_type:parseInt(n,10),severity:parseInt(N,10),permit_status:parseInt(R,10),ppe_status:parseInt(F,10),toolbox_train:C==="true",toolbox_reference_number:S,accident_image:V,about_the_accident:b,whitelevel:g,reported_by:l.map(({employee:s,employee_name:m,whitelevel_id:u})=>({employee:s,employee_name:m,whitelevel_id:u})),workmen:o.map(({employee:s,employee_name:m,whitelevel_id:u})=>({employee:s,employee_name:m,whitelevel_id:u})),supervisors:r.map(({employee:s,employee_name:m,whitelevel_id:u})=>({employee:s,employee_name:m,whitelevel_id:u}))};console.log("Submitting the following data:"),console.log(JSON.stringify(c,null,2));try{const s=await U.post("/accident/create/",c);console.log("Success:",s.data),window.alert("Accident Form submitted successfully!"),_e(c)}catch(s){if(s.isAxiosError&&s.response){console.error(`HTTP error! status: ${s}`);const m=JSON.stringify(s.response.data);console.error("Response body:",m),alert(`Error: ${m}`)}else s.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",s),alert(`Error fetching data: ${s.message}`));console.error("Error in handleSubmit:",s.message),window.alert("Error submitting form. Please try again.")}finally{B(!1)}},xe=async t=>{t.preventDefault(),B(!0);const c={date_of_accident:k,accident_id:j,accident_type:parseInt(n,10),severity:parseInt(N,10),permit_status:parseInt(R,10),ppe_status:parseInt(F,10),toolbox_train:C==="true",toolbox_reference_number:S,accident_image:V,about_the_accident:b,whitelevel_id:g,reported_by:l.map(({employee:s,employee_name:m,whitelevel_id:u})=>({employee_id:s,employee_name:m,whitelevel_id:u})),workmen:o.map(({employee:s,employee_name:m,whitelevel_id:u})=>({employee_id:s,employee_name:m,whitelevel_id:u})),supervisors:r.map(({employee:s,employee_name:m,whitelevel_id:u})=>({employee_id:s,employee_name:m,whitelevel_id:u}))};try{const s=await U.put("accident/accident-details-update/",c);console.log("Updated Accident:",s.data),alert("Updated Accident:",s.data)}catch(s){console.error("Error:",s),M("An error occurred while updating the accident.")}finally{B(!1)}};return e.jsxs(Ae,{children:[e.jsx(E,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:e.jsx("form",{onSubmit:fe,children:e.jsx(Fe,{sx:{maxwidth:"100%",padding:3,boxShadow:3},children:e.jsxs(Be,{children:[e.jsxs(h,{container:!0,spacing:2,children:[e.jsx(h,{item:!0,xs:12,sm:5.5,children:e.jsx($,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:k,onChange:ce,error:!!i.accident_report_date,helperText:i.accident_report_date,required:!0})}),e.jsx(h,{item:!0,xs:12,sm:5.5,children:e.jsx($,{label:"Reference Number",fullWidth:!0,onChange:me,value:j,error:!!i.accident_id,helperText:i.accident_id,required:!0})}),e.jsx(h,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},children:e.jsx(X,{variant:"contained",color:"secondary",onClick:le,fullWidth:!0,disabled:Y,children:"ok"})})]}),e.jsx(Pe,{sx:{marginY:3}}),e.jsxs(P,{component:"fieldset",margin:"normal",error:!!i.accident_type,children:[e.jsx(L,{component:"legend",children:"Incident Type*:"}),e.jsxs(z,{row:!0,value:n,onChange:ne,children:[e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"Accident"}),e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"Near Miss"}),e.jsx(_,{value:"3",control:e.jsx(y,{}),label:" Safety Violation"})]}),i.accident_type&&e.jsx(x,{color:"error",children:i.accident_type})]}),n&&e.jsxs(h,{container:!0,spacing:2,children:[e.jsxs(h,{item:!0,xs:12,children:[e.jsx(x,{gutterBottom:!0,children:"Reported By: (Enter 0 in case of Others)"}),e.jsx(te,{onEmployeesChange:t=>Q("reported_by",t),initialWhitelevelId:g,initialData:l}),Array.isArray(i.reported_by)&&i.reported_by.length>0&&e.jsx(E,{children:i.reported_by.map((t,c)=>e.jsxs(E,{children:[t.employee_id&&e.jsx(x,{color:"error",children:`Employee ${c+1} ID: ${t.employee_id}`}),t.employee_name&&e.jsx(x,{color:"error",children:`Employee ${c+1} Name: ${t.employee_name}`})]},c))})]}),e.jsxs(h,{item:!0,xs:12,children:[e.jsx(x,{gutterBottom:!0,children:"Workmen Involved*: (Enter 0 in case of Others)"}),e.jsx(te,{onEmployeesChange:t=>Q("workmen",t),initialWhitelevelId:g,initialData:o}),i.workmen&&typeof i.workmen=="string"&&e.jsx(E,{children:e.jsx(x,{color:"error",children:i.workmen})}),Array.isArray(i.workmen)&&i.workmen.length>0&&e.jsx(E,{children:i.workmen.map((t,c)=>e.jsxs(E,{children:[t.employee_id&&e.jsx(x,{color:"error",children:`Employee ${c+1} ID: ${t.employee_id}`}),t.employee_name&&e.jsx(x,{color:"error",children:`Employee ${c+1} Name: ${t.employee_name}`})]},c))})]}),e.jsxs(h,{item:!0,xs:12,children:[e.jsx(x,{gutterBottom:!0,children:"Supervisor:"}),e.jsx(Re,{onChange:t=>Q("supervisors",t),initialWhitelevelId:g,initialData:r}),Array.isArray(i.supervisors)&&i.supervisors.length>0&&e.jsx(E,{children:i.supervisors.map((t,c)=>e.jsxs(E,{children:[t.employee_id&&e.jsx(x,{color:"error",children:`Supervisor ${c+1} ID: ${t.employee_id}`}),t.employee_name&&e.jsx(x,{color:"error",children:`Supervisor ${c+1} Name: ${t.employee_name}`})]},c))})]}),n==="2"&&e.jsxs(e.Fragment,{children:[e.jsx(h,{item:!0,xs:12,children:e.jsxs(P,{component:"fieldset",error:!!i.severity,children:[e.jsx(L,{component:"legend",children:"Severity*"}),e.jsxs(z,{row:!0,value:N,onChange:de,children:[e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"1"}),e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"2"}),e.jsx(_,{value:"3",control:e.jsx(y,{}),label:"3"}),e.jsx(_,{value:"4",control:e.jsx(y,{}),label:"4"}),e.jsx(_,{value:"5",control:e.jsx(y,{}),label:"5"})]}),i.severity&&e.jsx(x,{color:"error",children:i.severity})]})}),e.jsx(h,{item:!0,xs:12,children:e.jsxs(P,{component:"fieldset",error:!!i.permit_status,children:[e.jsx(L,{component:"legend",children:"Permit Status*"}),e.jsxs(z,{row:!0,value:R,onChange:pe,children:[e.jsx(_,{value:"4",control:e.jsx(y,{}),label:"Valid"}),e.jsx(_,{value:"3",control:e.jsx(y,{}),label:"Not Required"}),e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"No Permit"}),e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"Expired"})]}),i.permit_status&&e.jsx(x,{color:"error",children:i.permit_status})]})}),e.jsx(h,{item:!0,xs:12,sm:6,children:e.jsxs(P,{component:"fieldset",error:!!i.ppe_status,children:[e.jsx(L,{component:"legend",children:"PPE Status*"}),e.jsxs(z,{row:!0,value:F,onChange:ue,children:[e.jsx(_,{value:"2",control:e.jsx(y,{}),label:"OK"}),e.jsx(_,{value:"1",control:e.jsx(y,{}),label:"Faulty"})]}),i.ppe_status&&e.jsx(x,{color:"error",children:i.ppe_status})]})}),e.jsxs(h,{item:!0,xs:12,sm:6,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(L,{component:"legend",children:"Tool Box Talk*"}),e.jsxs(z,{row:!0,value:C,onChange:ie,children:[e.jsx(_,{value:"true",control:e.jsx(y,{}),label:"Yes"}),e.jsx(_,{value:"false",control:e.jsx(y,{}),label:"No"})]})]}),C==="true"&&e.jsx($,{label:"ToolBox Reference Number",fullWidth:!0,onChange:he,value:S,sx:{marginTop:2},error:!!i.toolbox_reference_number,helperText:i.toolbox_reference_number})]})]}),e.jsx(h,{item:!0,xs:12,children:e.jsx(P,{fullWidth:!0,margin:"normal",children:e.jsx($,{label:"Description....",multiline:!0,rows:4,value:b,onChange:oe})})}),e.jsx(h,{item:!0,xs:12,children:e.jsx(Se,{setCompressedImageBase64:K,compressedImageBase64:V})})]}),e.jsxs(h,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[e.jsx(h,{item:!0,xs:12,md:6,children:e.jsx(X,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:Y,children:"Submit Accident"})}),e.jsx(h,{item:!0,xs:12,md:6,children:e.jsx(X,{variant:"contained",color:"secondary",onClick:xe,fullWidth:!0,disabled:Y,children:"Update Accident"})})]})]})})})}),e.jsx(ke,{open:Y,sx:{color:"#fff",zIndex:t=>t.zIndex.drawer+1},children:e.jsx($e,{color:"inherit"})})]})};export{tr as default};
