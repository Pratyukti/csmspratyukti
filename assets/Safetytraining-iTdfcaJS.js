import{h as Y,r as m,j as r,D as P}from"./index-UGP3FMHZ.js";import{B as ee}from"./Box-CbM13dhw.js";import{T as ue,a as pe,b as he,c as X,d as w,e as ge}from"./TableRow-DQtWHTn5.js";import{P as K,L as fe,I as ye,T as F}from"./IconButton-Dte1ZgIo.js";import{T as q,F as M}from"./TextField-DrQtiYXb.js";import{L as _e,R as Te,a as $}from"./RadioGroup-DO-H920W.js";import{D as xe,F as je,A as be,T as ve,I as Se}from"./Training4-Cn9_KTuY.js";import{C as Ie}from"./Container-GS8ffijV.js";import{C as Ce,a as De,D as Ee}from"./CardContent-uEhRVXsi.js";import{G as f}from"./Grid-BXojtv6-.js";import{B as V}from"./Button-g9Q44_9z.js";import{F as z}from"./FormControlLabel-C7ZkyQm7.js";import"./createSvgIcon-CSQ9e_07.js";import"./styled-BlKDz0Ha.js";import"./dividerClasses-M2P_bjZl.js";const we=({onEmployeesChange:A,initialData:y})=>{const R=Y(e=>e.userInfo),[l,_]=m.useState(y||[]),[v,L]=m.useState(R.whitelevel_id),[T,D]=m.useState({}),[E,S]=m.useState({});m.useEffect(()=>{if(Array.isArray(y)&&y.length>0&&l.length===0){console.log("initialData :",y);const e=y.map(t=>({...t}));_(t=>JSON.stringify(t)===JSON.stringify(e)?t:e)}},[y]);const U=async(e,t)=>{try{return(await P.post("/employee/name/",{employee_id:e,whitelevel_id:t})).data.employee_name||""}catch(i){return console.error("Error fetching employee name:",i),""}},B=async e=>{try{return(await P.get(`/employee/search/?nameQuery=${e}`)).data||[]}catch(t){return console.error("Error fetching employee suggestions:",t),[]}};m.useEffect(()=>{A(l.map(e=>({employee:e.employee_id,whitelevel_id:v,employee_id:e.employee_id==="0"?"":e.employee_id,employee_name:e.employee_id==="0"?e.name:e.employee_name,trainer_id:e.employee_id,trainer_name:e.employee_id==="0"?e.name:e.employee_name,trainee_id:e.employee_id==="0"?"":e.employee_id,trainee_name:e.employee_id==="0"?"":e.employee_name})))},[l,A]);const x=e=>/^[a-zA-Z\s.]*$/.test(e),W=()=>{if(l.length===0||l[l.length-1].employee_id&&(l[l.length-1].employee_name||l[l.length-1].name))_([...l,{employee_id:"",whitelevel_id:v,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const t=[...l];l[l.length-1].employee_id||(t[l.length-1].employee_id_error=!0),l[l.length-1].employee_name||l[l.length-1].name||(t[l.length-1].employee_name_error=!0),_(t)}},j=e=>{const t=l.filter((i,u)=>u!==e);_(t)},N=async(e,t)=>{const{name:i,value:u}=t.target,a=[...l];if(i==="employee_name"||i==="name")if(x(u))a[e].invalidCharacterError=!1;else{a[e].invalidCharacterError=!0,_(a);return}if(a[e][i]=u,i==="employee_id")if(a[e].employee_id_error=!1,a[e].error="",u==="0")a[e].employee_name="",a[e].manual=!0,a[e].disableNameField=!1;else{const p=a.some((b,I)=>b.employee_id===u&&I!==e);if(a[e].error=p?"duplicate":"",p)a[e].disableNameField=!0;else{const b=await U(u,v);b?(a[e].employee_name=b,a[e].manual=!1,a[e].disableNameField=!0):(a[e].error="invalid",a[e].employee_name="",a[e].disableNameField=!0)}}else if(i==="employee_name")if(u.length>0)if(a.some((b,I)=>b.employee_name===u&&I!==e))a[e].error="duplicate",a[e].disableIDField=!0;else{const b=await B(u);D(I=>({...I,[e]:b})),S(I=>({...I,[e]:!0})),a[e].disableIDField=!1}else D(p=>({...p,[e]:[]})),S(p=>({...p,[e]:!1}));else a[e].employee_name_error=!1,i==="name"&&l[e].employee_id==="0"&&(a[e].employee_name_error=!1,a[e].error="");_(a)},k=(e,t)=>{const i=[...l];i.some((a,p)=>a.employee_name===t.employee_name&&p!==e)?(i[e].error="duplicate",i[e].employee_id_error=!0,i[e].employee_name=t.employee_name,i[e].employee_id="",i[e].disableIDField=!0):(i[e].employee_name=t.employee_name,i[e].employee_id=t.employee_id,i[e].manual=!1,i[e].error="",i[e].employee_id_error=!1,i[e].disableIDField=!1),D(a=>({...a,[e]:[]})),S(a=>({...a,[e]:!1})),_(i)},O=e=>{setTimeout(()=>{S(t=>({...t,[e]:!1}))},200)};return r.jsxs(ee,{sx:{position:"relative"},children:[r.jsx(ue,{component:K,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:r.jsxs(pe,{children:[r.jsx(he,{children:r.jsxs(X,{children:[r.jsx(w,{children:"Sl. No"}),r.jsx(w,{sx:{pl:12},children:"Employee ID"}),r.jsx(w,{sx:{pl:12},children:"Employee Name"}),r.jsx(w,{sx:{pl:2},children:"Actions"})]})}),r.jsx(ge,{children:l.map((e,t)=>r.jsxs(X,{children:[r.jsx(w,{children:t+1}),r.jsx(w,{children:r.jsx(q,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id,onChange:i=>N(t,i),fullWidth:!0,required:!0,error:!!e.error||e.employee_id_error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.employee_id_error?"Employee ID is required":"",disabled:e.disableIDField,onFocus:()=>S(i=>({...i,[t]:!1}))})}),r.jsxs(w,{children:[r.jsx(q,{variant:"outlined",size:"small",name:e.manual?"name":"employee_name",value:e.manual?e.name:e.employee_name,onChange:i=>N(t,i),onBlur:()=>O(t),fullWidth:!0,required:!0,disabled:e.disableNameField,error:e.employee_name_error||e.invalidCharacterError,helperText:e.invalidCharacterError?"Invalid characters in employee name":e.employee_name_error?"Employee name is required":""}),E[t]&&T[t]&&r.jsx(K,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:r.jsx(fe,{sx:{maxHeight:200,overflow:"auto"},children:T[t].map((i,u)=>r.jsx(_e,{button:!0,onClick:()=>k(t,i),children:`${i.employee_name}`},u))})})]}),r.jsx(w,{children:r.jsx(ye,{color:"primary",onClick:()=>j(t),children:r.jsx(xe,{})})})]},t))})]})}),r.jsx(je,{color:"primary",size:"small",onClick:W,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:r.jsx(be,{})})]})},Ge=()=>{const A=Y(d=>d.userInfo),[y,R]=m.useState(A.whitelevel_id),[l,_]=m.useState(new Date().toISOString().split("T")[0]),[v,L]=m.useState(""),[T,D]=m.useState("4"),[E,S]=m.useState(""),[U,B]=m.useState(!1),[x,W]=m.useState([]),[j,N]=m.useState([]),[k,O]=m.useState(""),[e,t]=m.useState(!1),[i,u]=m.useState("");m.useState({option1:!1});const[a,p]=m.useState({trainingDate:"",trainingId:"",whitelevelId:"",trainingType:"",trainingName:"",trainers:"",trainees:"",image:"",about_the_training:""}),[b,I]=m.useState(!1),J=(d,s)=>{const n=d.map(h=>h.trainer_id),c=s.map(h=>h.trainee_id);return n.filter(h=>c.includes(h)).length>0},G=j&&j.length>0?[...j]:[],H=x&&x.length>0?[...x]:[];m.useEffect(()=>{console.log("UpdatedTrainees:",G),console.log("UpdatedTrainers:",H)},[G,H]);const re=async d=>{if(d.target,!!v){t(!0),t(!0);try{const s=await P.post("/training/training-details/",{training_id:v,whitelevel_id:y}),n=s.data;n?(_(n.training_date),D(n.training_type),S(n.training_name),W(n.trainers.map(c=>({employee_id:c.employee_id,employee_name:c.trainer_name}))),N(n.trainees.map(c=>({employee_id:c.employee_id,employee_name:c.trainee_name}))),O(n.training_image),u(n.about_the_training)):alert("No SafetyTraining data found. Please check the reference number."),console.log("Fetched data:",s.data)}catch(s){console.error("Error fetching accident data:",s),p({fetch:"Failed to fetch accident data. Please try again."})}finally{t(!1)}}},Q=(d,s)=>{let n={...a};if(d==="trainers"&&(W(s),b)){let c=[],g=!1;if(s.forEach((h,o)=>{h.trainer_id!=="0"&&(!h.trainer_id||!h.trainer_name)&&(c.push(`Trainer ${o+1} has empty fields.`),g=!0)}),g){n.trainers=c.join(" "),p(n);return}J(s,j)?(n.trainers="Trainer and Trainee employee codes should not be equal",n.trainees="Trainer and Trainee employee codes should not be equal"):(n.trainers="",n.trainees="")}if(d==="trainees"&&(N(s),b)){let c=[],g=!1;if(s.forEach((h,o)=>{h.trainee_id!=="0"&&(!h.trainee_id||!h.trainee_name)&&(c.push(`Trainee ${o+1} has empty fields.`),g=!0)}),g){n.trainees=c.join(" "),p(n);return}J(x,s)?(n.trainers="Trainer and Trainee employee codes should not be equal",n.trainees="Trainer and Trainee employee codes should not be equal"):(n.trainers="",n.trainees="")}},ae=d=>{R(d.target.value)},te=d=>{_(d.target.value)},ne=d=>{const s=d.target.value;D(s),B(s==="1"),p({...a,trainingType:s===""?"Training Type is required":""})},ie=d=>{const s=d.target.value,n=/^[A-Za-z\s]*$/;S(s),T==="1"&&(n.test(s)?p({...a,trainingName:""}):p({...a,trainingName:"Training Name must contain only alphabets and spaces"}))},se=d=>{L(d.target.value)},le=d=>{u(d.target.value)},oe=new Date().toISOString().split("T")[0],de=()=>{R(A.whitelevel_id),_(new Date().toISOString().split("T")[0]),L(""),D("4"),S(""),B(!1),W([]),N([]),O(""),u("")},me=async d=>{var g,h;d.preventDefault(),t(!0),I(!0);let s=!0;const n={trainingDate:l?"":"Training Date is required",trainingId:v?"":"Training ID is required",whitelevelId:y?"":"Whitelevel ID is required",trainingType:T?"":"Training Type is required",trainingName:T==="1"&&!E?"Training Name is required":"",trainers:x.length===0?"At least one Trainer is required":"",trainees:j.length===0?"At least one Trainee is required":""};if(T==="1"&&(E?/^[A-Za-z\s]*$/.test(E)||(n.trainingName="Training Name must contain only alphabets and spaces",s=!1):(n.trainingName="Training Name is required",s=!1)),Object.keys(n).forEach(o=>{n[o]&&(s=!1)}),x.forEach((o,C)=>{o.trainer_id!=="0"&&(!o.trainer_id||!o.trainer_name)&&(n[`trainer_${C}_name`]="Trainer name is required",s=!1)}),j.forEach((o,C)=>{o.trainee_id!=="0"&&(!o.trainee_id||!o.trainee_name)&&(n[`trainee_${C}_name`]="Trainee name is required",s=!1)}),J(x,j)&&(n.trainers="Trainer and Trainee employee codes should not be equal",n.trainees="Trainer and Trainee employee codes should not be equal",s=!1),p(n),!s){t(!1);return}const c={training_id:v,training_date:l,whitelevel_id:y,training_type:T,training_image:k,about_the_training:i,training_name:T==="1"?E:null,trainers:x.map(({trainer_id:o,whitelevel_id:C,trainer_name:Z})=>({trainer_id:o,whitelevel_id:C,trainer_name:Z})),trainees:j.map(({trainee_id:o,trainee_name:C,whitelevel_id:Z})=>({trainee_id:o,whitelevel_id:Z,trainee_name:C}))};console.log("Submitting the following data:"),console.log(JSON.stringify(c,null,2));try{const o=await P.post("/training/start/",c);console.log("Success:",o.data),window.alert("Safety Training Form submitted successfully!"),de(),R(A.whitelevel_id),_(new Date().toISOString().split("T")[0]),L(""),D("4"),S(""),B(!1),W([]),N([]),O(""),u("")}catch(o){if(o.response){console.error(`HTTP error! Status: ${o.response.status}`);const C=JSON.stringify(o.response.data);console.error("Response body:",C),((h=(g=o.response.data)==null?void 0:g.training_id)==null?void 0:h[0])==="training with this training id already exists."?window.alert("Training ID already exists. Please use a different ID."):window.alert("Error submitting form. Please check the details and try again.")}else o.isAxiosError?(console.error("Axios error:",o.message),window.alert("An error occurred with the request. Please try again.")):o.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),window.alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",o.message),window.alert(`Error fetching data: ${o.message}`))}finally{t(!1)}},ce=async d=>{d.preventDefault(),t(!0);const s={training_id:v,training_type:T,training_name:E,whitelevel_id:y,image:k,about_the_training:i,training_image:k,trainers:x.map(({trainer_id:n,whitelevel_id:c,trainer_name:g})=>({employee_id:n,whitelevel_id:c,trainer_name:g})),trainees:j.map(({trainee_id:n,trainee_name:c,whitelevel_id:g})=>({employee_id:n,whitelevel_id:g,trainee_name:c}))};try{const n=await P.put("/training/training-details-update/",s);console.log("Updated Training:",n.data),alert("Updated Training:",n.data)}catch(n){console.error("Error:",n),p("An error occurred while updating the accident.")}finally{t(!1)}};return r.jsx(Ie,{children:r.jsx(ee,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:r.jsx("form",{onSubmit:me,children:r.jsx(Ce,{sx:{maxwidth:"100%",padding:3,boxShadow:3},children:r.jsx(De,{children:r.jsxs(f,{container:!0,spacing:2,children:[r.jsx(f,{item:!0,xs:12,sm:5.5,children:r.jsx(q,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:l,onChange:te,max:oe,error:!!a.trainingDate,helperText:a.trainingDate,required:!0})}),r.jsx(f,{item:!0,xs:12,sm:5.5,children:r.jsx(q,{label:"Reference Number",fullWidth:!0,value:v,onChange:se,error:!!a.trainingId,helperText:a.trainingId})}),r.jsx(f,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},children:r.jsx(V,{variant:"contained",color:"secondary",onClick:re,fullWidth:!0,disabled:e,children:"ok"})}),r.jsxs(f,{item:!0,xs:12,children:[r.jsx(F,{variant:"h6",style:{display:"none"},children:"Whitelevel ID:"}),r.jsx(M,{fullWidth:!0,margin:"normal",style:{display:"none"},children:r.jsx(q,{style:{display:"none"},label:"Whitelevel ID",fullWidth:!0,value:y,onChange:ae,error:!!a.whitelevelId,helperText:a.whitelevelId})})]}),r.jsxs(f,{item:!0,xs:12,children:[r.jsx(F,{variant:"h6",sx:{marginBottom:1},required:!0,children:"Training Type *:"}),r.jsxs(Te,{row:!0,value:T,onChange:ne,children:[r.jsx(z,{value:"4",control:r.jsx($,{}),label:"Tool box Training"}),r.jsx(z,{value:"3",control:r.jsx($,{}),label:"Job & Safety"}),r.jsx(z,{value:"2",control:r.jsx($,{}),label:"Behavioural"}),r.jsx(z,{value:"1",control:r.jsx($,{}),label:"Others"})]}),U&&r.jsx(q,{label:"Name of Training",fullWidth:!0,value:E,onChange:ie,error:!!a.trainingName,helperText:a.trainingName}),a.trainingType&&r.jsx(F,{variant:"body2",color:"error",sx:{mt:1},children:a.trainingType})]}),r.jsxs(f,{item:!0,xs:12,children:[r.jsx(Ee,{sx:{marginBottom:3}}),r.jsx(F,{variant:"h6",children:"TRAINER *: (Enter 0 in case of Others)"}),r.jsx(we,{onEmployeesChange:d=>Q("trainers",d),error:!!a.trainers,helperText:a.trainers,initialData:H}),a.trainers&&r.jsx(F,{variant:"body2",color:"error",sx:{mt:1},children:a.trainers})]}),r.jsxs(f,{item:!0,xs:12,children:[r.jsx(F,{variant:"h6",children:"TRAINEE *:"}),r.jsx(ve,{onChange:d=>Q("trainees",d),error:!!a.trainees,helperText:a.trainees,initialData:G}),a.trainees&&r.jsx(F,{variant:"body2",color:"error",sx:{mt:1},children:a.trainees})]}),r.jsx(f,{item:!0,xs:12,children:r.jsx(M,{fullWidth:!0,margin:"normal",children:r.jsx(q,{label:"Description",multiline:!0,rows:4,value:i,onChange:le})})}),r.jsx(f,{item:!0,xs:12,children:r.jsx(Se,{setCompressedImageBase64:O,compressedImageBase64:k})}),r.jsxs(f,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[r.jsx(f,{item:!0,xs:12,md:6,children:r.jsx(V,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:e,children:"Submit"})}),r.jsx(f,{item:!0,xs:12,md:6,children:r.jsx(V,{variant:"contained",color:"secondary",onClick:ce,fullWidth:!0,disabled:e,children:"Update"})})]})]})})})})})})};export{Ge as default};
