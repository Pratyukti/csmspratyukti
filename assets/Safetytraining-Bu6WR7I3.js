import{h as ze,r as d,j as t,D as S}from"./index-ClV15evO.js";import{D as re,F as te,A as le,I as Le}from"./Delete-rtlks4SK.js";import{C as $e}from"./Container-DSFVk6K_.js";import{B as k}from"./Box-bCNXVwYJ.js";import{C as Ue,a as Je,D as Me}from"./CardContent-B4wlWcKs.js";import{G as h}from"./Grid-CukM0hiV.js";import{T as _,F as se}from"./TextField-Dyqu7dDL.js";import{B as V}from"./Button-C22GjKN7.js";import{T as v,P as Z,L as Ge,I as ie}from"./IconButton-9uWMncTP.js";import{R as He,a as A,L as Ve}from"./RadioGroup-EMHDKaMR.js";import{F as W}from"./FormControlLabel-nTT0Z78y.js";import{T as ne,a as oe,b as de,c as B,d as p,e as me}from"./TableRow-WBDk2Q7z.js";import"./createSvgIcon-Bo4oMKsv.js";import"./styled-DJ2ZZm4A.js";import"./dividerClasses-Ce9XUCVp.js";const pa=Ze=>{const O=ze(e=>e.userInfo),[b,P]=d.useState(O.whitelevel_id),[z,D]=d.useState(new Date().toISOString().split("T")[0]),[T,L]=d.useState(""),[x,C]=d.useState("4"),[w,E]=d.useState(""),[ce,$]=d.useState(!1);d.useState([]),d.useState([]);const[N,F]=d.useState(""),[U,j]=d.useState(!1),[J,R]=d.useState("");d.useState({option1:!1});const[u,f]=d.useState([]),[n,g]=d.useState([{employee_id:"",employee_name:"",manual:!1,disableNameField:!1}]),[q,M]=d.useState([]),[pe,X]=d.useState(null),[ue,he]=d.useState(null),[ye,I]=d.useState({}),[Q,Xe]=d.useState(null),[c,y]=d.useState({trainingDate:"",trainingId:"",whitelevelId:"",trainingType:"",trainingName:"",rows1:"",rows:"",image:"",about_the_training:""}),[K,ge]=d.useState(!1),fe=e=>/^[a-zA-Z\s.]*$/.test(e),G=(e,r)=>{const a=e.map(o=>o.employee_id),s=r.map(o=>o.employee_id);return a.filter(o=>s.includes(o)).length>0},Y=async e=>{try{return(await S.post("/employee/name/",{employee_id:e,whitelevel_id:b})).data.employee_name||""}catch(r){return console.error("Error fetching employee name:",r),""}},_e=async e=>{try{return(await S.get(`/employee/search/?nameQuery=${e}`)).data||[]}catch(r){return console.error("Error fetching employee suggestions:",r),[]}},be=()=>{if(u.some(a=>typeof a.employee_id=="string"&&a.employee_id.trim()===""||typeof a.employee_name=="string"&&a.employee_name.trim()==="")){alert("Please fill in all the fields before adding a new row.");const a=u.map(s=>({...s,error:typeof s.employee_id=="string"&&s.employee_id.trim()===""||typeof s.employee_name=="string"&&s.employee_name.trim()===""?"empty_field":s.error}));f(a),console.log("Updated rows after adding a row with empty fields:",a);return}const r=[...u,{employee_id:"",whitelevel_id:b,employee_name:"",error:null,disableNameField:!1}];f(r),console.log("Updated rows after adding a new row:",r)},xe=()=>{if(n.length===0||n[n.length-1].employee_id&&(n[n.length-1].employee_name||n[n.length-1].name))g([...n,{employee_id:"",whitelevel_id:b,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const r=[...n];n[n.length-1].employee_id||(r[n.length-1].employee_id_error=!0),n[n.length-1].employee_name||n[n.length-1].name||(r[n.length-1].employee_name_error=!0),g(r)}},je=e=>{const r=u.filter((a,s)=>s!==e);f(r),console.log("Updated rows after deleting a row:",r)},ve=e=>{const r=n.filter((a,s)=>s!==e);g(r),console.log("Updated rows after deleting a row:",r)},Te=async(e,r)=>{const{name:a,value:s}=r.target,l=[...u];if(l[e][a]=s.trim(),a==="employee_id")if(l.some((i,m)=>i.employee_id===s&&m!==e))l[e].error="duplicate",l[e].employee_name="",l[e].disableNameField=!0;else if(s.trim()!==""){const i=await Y(s);i?(l[e].employee_name=i,l[e].error=null,l[e].disableNameField=!0):(l[e].employee_name="",l[e].error="invalid",l[e].disableNameField=!0)}else l[e].employee_name="",l[e].error=null,l[e].disableNameField=!1;f(l),console.log("Updated rows after employee_id input change:",l)},we=e=>{let r={};if(Q==="rows1"&&(g(e),K)){let a=[],s=!1;if(e.forEach((l,o)=>{l.employee_id!=="0"&&(!l.employee_id||!l.employee_name)&&(a.push(`Trainer ${o+1} has empty fields.`),s=!0)}),s){r.rows1=a.join(" "),y(r);return}G(e,u)?(r.rows1="Trainer and Trainee employee codes should not be equal",r.rows="Trainer and Trainee employee codes should not be equal",y(r)):(r.rows1="",r.rows="",y(r))}if(Q==="rows"&&(f(e),K)){let a=[],s=!1;if(e.forEach((l,o)=>{l.employee_id!=="0"&&(!l.employee_id||!l.employee_name)&&(a.push(`Trainee ${o+1} has empty fields.`),s=!0)}),s){r.rows=a.join(" "),y(r);return}G(n,u)?(r.rows1="Trainer and Trainee employee codes should not be equal",r.rows="Trainer and Trainee employee codes should not be equal",y(r)):(r.rows="",r.rows1="",y(r))}},ee=async(e,r)=>{const{name:a,value:s}=r.target,l=[...n];if(a==="employee_name"||a==="name")if(fe(s))l[e].invalidCharacterError=!1;else{l[e].invalidCharacterError=!0,g(l);return}if(l[e][a]=s,a==="employee_id")if(l[e].employee_id_error=!1,l[e].error="",s==="0")l[e].employee_name="",l[e].manual=!0,l[e].disableNameField=!1;else{const o=l.some((i,m)=>i.employee_id===s&&m!==e);if(l[e].error=o?"duplicate":"",o)l[e].disableNameField=!0;else{const i=await Y(s);i?(l[e].employee_name=i,l[e].manual=!1,l[e].disableNameField=!0):(l[e].error="invalid",l[e].employee_name="",l[e].disableNameField=!0)}}else if(a==="employee_name")if(s.length>0)if(l.some((i,m)=>i.employee_name===s&&m!==e))l[e].error="duplicate",l[e].disableIDField=!0;else{const i=await _e(s);M(m=>({...m,[e]:i})),I(m=>({...m,[e]:!0})),l[e].disableIDField=!1}else M(o=>({...o,[e]:[]})),I(o=>({...o,[e]:!1}));else l[e].employee_name_error=!1,a==="name"&&n[e].employee_id==="0"&&(l[e].employee_name_error=!1,l[e].error="");g(l)},Ie=(e,r)=>{const a=[...u];a.some(l=>l.employee_id===r.employee_id&&l!==a[e])?(a[e].error="duplicate",a[e].disableNameField=!0):(a[e].employee_id=r.employee_id,a[e].employee_name=r.employee_name,a[e].error=null,a[e].disableNameField=!0),f(a),M([]),he(null),console.log("Updated rows after suggestion click:",a)},Se=e=>{X(e)},De=()=>{X(null)},Ce=async e=>{if(e.target,!!T){j(!0),j(!0);try{const r=await S.post("/training/training-details/",{training_id:T,whitelevel_id:b}),a=r.data;a?(D(a.training_date),C(a.training_type),E(a.training_name),g(a.trainers.map(s=>({employee_id:s.employee_id,employee_name:s.trainer_name}))),f(a.trainees.map(s=>({employee_id:s.employee_id,employee_name:s.trainee_name}))),F(a.training_image),R(a.about_the_training)):alert("No SafetyTraining data found. Please check the reference number."),console.log("Fetched data:",r.data)}catch(r){console.error("Error fetching accident data:",r),y({fetch:"Failed to fetch accident data. Please try again."})}finally{j(!1)}}},Ee=e=>{P(e.target.value)},Ne=e=>{D(e.target.value)},Fe=e=>{const r=e.target.value;C(r),$(r==="1"),y({...c,trainingType:r===""?"Training Type is required":""})},Re=e=>{const r=e.target.value,a=/^[A-Za-z\s]*$/;E(r),x==="1"&&(a.test(r)?y({...c,trainingName:""}):y({...c,trainingName:"Training Name must contain only alphabets and spaces"}))},qe=e=>{L(e.target.value)},ke=e=>{R(e.target.value)},Ae=new Date().toISOString().split("T")[0],ae=()=>{P(O.whitelevel_id),D(new Date().toISOString().split("T")[0]),L(""),C("4"),E(""),$(!1),f([]),g([]),F(""),R("")},We=async e=>{var l,o;e.preventDefault(),j(!0),ge(!0),we();let r=!0;const a={trainingDate:z?"":"Training Date is required",trainingId:T?"":"Training ID is required",whitelevelId:b?"":"Whitelevel ID is required",trainingType:x?"":"Training Type is required",trainingName:x==="1"&&!w?"Training Name is required":"",rows1:n.length===0?"At least one Trainer is required":"",rows:u.length===0?"At least one Trainee is required":""};if(x==="1"&&(w?/^[A-Za-z\s]*$/.test(w)||(a.trainingName="Training Name must contain only alphabets and spaces",r=!1):(a.trainingName="Training Name is required",r=!1)),Object.keys(a).forEach(i=>{a[i]&&(r=!1)}),n.forEach((i,m)=>{i.employee_id!=="0"&&(!i.employee_id||!i.employee_name)&&(a[`trainer_${m}_name`]="Trainer name is required",r=!1)}),u.forEach((i,m)=>{i.employee_id_id!=="0"&&(!i.employee_id||!i.employee_name)&&(a[`trainee_${m}_name`]="Trainee name is required",r=!1)}),G(n,u)&&(a.rows1="Trainer and Trainee employee codes should not be equal",a.rows="Trainer and Trainee employee codes should not be equal",r=!1),y(a),!r){j(!1);return}const s={training_id:T,training_date:z,whitelevel_id:b,training_type:x,training_image:N,about_the_training:J,training_name:x==="1"?w:null,trainers:n.map(({employee_id:i,whitelevel_id:m,employee_name:H})=>({trainer_id:i,whitelevel_id:m,trainer_name:H})),trainees:u.map(({employee_id:i,employee_name:m,whitelevel_id:H})=>({trainee_id:i,whitelevel_id:H,trainee_name:m}))};console.log("Submitting the following data:"),console.log(JSON.stringify(s,null,2));try{const i=await S.post("/training/start/",s);console.log("Success:",i.data),window.alert("Safety Training Form submitted successfully!"),ae(),P(O.whitelevel_id),D(new Date().toISOString().split("T")[0]),L(""),C("4"),E(""),$(!1),g([]),f([]),F(""),R("")}catch(i){if(i.response){console.error(`HTTP error! Status: ${i.response.status}`);const m=JSON.stringify(i.response.data);console.error("Response body:",m),((o=(l=i.response.data)==null?void 0:l.training_id)==null?void 0:o[0])==="training with this training id already exists."?window.alert("Training ID already exists. Please use a different ID."):window.alert("Error submitting form. Please check the details and try again.")}else i.isAxiosError?(console.error("Axios error:",i.message),window.alert("An error occurred with the request. Please try again.")):i.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),window.alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",i.message),window.alert(`Error fetching data: ${i.message}`))}finally{j(!1)}},Be=async e=>{e.preventDefault(),j(!0);const r={training_id:T,training_type:x,training_name:w,whitelevel_id:b,image:N,about_the_training:J,training_image:N,trainers:n.map(({employee_id:a,whitelevel_id:s,employee_name:l})=>({employee_id:a,whitelevel_id:s,trainer_name:l})),trainees:u.map(({employee_id:a,employee_name:s,whitelevel_id:l})=>({employee_id:a,whitelevel_id:l,trainee_name:s}))};console.log(JSON.stringify(r,null,2));try{const a=await S.put("/training/training-details-update/",r);console.log("Updated Training:",a.data),alert("Updated Training SucessFully:",a.data),ae()}catch(a){console.error("Error:",a),y("An error occurred while updating the accident.")}finally{j(!1)}},Oe=(e,r)=>{const a=[...n];a.some((l,o)=>l.employee_name===r.employee_name&&o!==e)?(a[e].error="duplicate",a[e].employee_id_error=!0,a[e].employee_name=r.employee_name,a[e].employee_id="",a[e].disableIDField=!0):(a[e].employee_name=r.employee_name,a[e].employee_id=r.employee_id,a[e].manual=!1,a[e].error="",a[e].employee_id_error=!1,a[e].disableIDField=!1),I(l=>({...l,[e]:!1})),g(a)},Pe=e=>{setTimeout(()=>{I(r=>({...r,[e]:!1}))},200)};return t.jsx($e,{maxWidth:"xl",children:t.jsx(k,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:t.jsx("form",{onSubmit:We,children:t.jsx(Ue,{sx:{width:"100%",padding:3,boxShadow:3},children:t.jsx(Je,{children:t.jsxs(h,{container:!0,spacing:3,children:[t.jsx(h,{item:!0,xs:12,sm:5.5,children:t.jsx(_,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:z,onChange:Ne,max:Ae,error:!!c.trainingDate,helperText:c.trainingDate,required:!0})}),t.jsx(h,{item:!0,xs:12,sm:5.5,children:t.jsx(_,{label:"Reference Number",fullWidth:!0,value:T,onChange:qe,error:!!c.trainingId,helperText:c.trainingId})}),t.jsx(h,{item:!0,xs:12,sm:1,children:t.jsx(V,{variant:"contained",color:"secondary",onClick:Ce,fullWidth:!0,disabled:U,children:"ok"})}),t.jsxs(h,{item:!0,xs:12,children:[t.jsx(v,{variant:"h6",style:{display:"none"},children:"Whitelevel ID:"}),t.jsx(se,{fullWidth:!0,margin:"normal",style:{display:"none"},children:t.jsx(_,{style:{display:"none"},label:"Whitelevel ID",fullWidth:!0,value:b,onChange:Ee,error:!!c.whitelevelId,helperText:c.whitelevelId})})]}),t.jsxs(h,{item:!0,xs:12,children:[t.jsx(v,{variant:"h6",sx:{marginBottom:1},required:!0,children:"Training Type *:"}),t.jsxs(He,{row:!0,value:x,onChange:Fe,children:[t.jsx(W,{value:"4",control:t.jsx(A,{}),label:"Tool box Training"}),t.jsx(W,{value:"3",control:t.jsx(A,{}),label:"Job & Safety"}),t.jsx(W,{value:"2",control:t.jsx(A,{}),label:"Behavioural"}),t.jsx(W,{value:"1",control:t.jsx(A,{}),label:"Others"})]}),ce&&t.jsx(_,{label:"Name of Training",fullWidth:!0,value:w,onChange:Re,error:!!c.trainingName,helperText:c.trainingName}),c.trainingType&&t.jsx(v,{variant:"body2",color:"error",sx:{mt:1},children:c.trainingType})]}),t.jsxs(h,{item:!0,xs:12,children:[t.jsx(Me,{sx:{marginBottom:3}}),t.jsx(v,{variant:"h6",children:"TRAINER *: (Enter 0 in case of Others)"}),t.jsxs(k,{sx:{position:"relative"},children:[c.rows1&&t.jsx(v,{variant:"body2",color:"error",sx:{mt:1},children:c.rows1}),t.jsx(ne,{component:Z,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:t.jsxs(oe,{children:[t.jsx(de,{children:t.jsxs(B,{children:[t.jsx(p,{children:"Sl. No"}),t.jsx(p,{sx:{pl:12},children:"Employee ID"}),t.jsx(p,{sx:{pl:12},children:"Employee Name"}),t.jsx(p,{sx:{pl:2},children:"Actions"})]})}),t.jsx(me,{children:n.map((e,r)=>t.jsxs(B,{children:[t.jsx(p,{children:r+1}),t.jsx(p,{children:t.jsx(_,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id!==0?e.employee_id:"",onChange:a=>ee(r,a),fullWidth:!0,required:!0,error:!!e.error||e.employee_id_error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.employee_id_error?"Employee ID is required":"",disabled:e.disableIDField,onFocus:()=>I(a=>({...a,[r]:!1}))})}),t.jsxs(p,{children:[t.jsx(_,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_id==="0"?e.name||e.employee_name:e.employee_name||"",onChange:a=>ee(r,a),onBlur:()=>Pe(r),fullWidth:!0,required:!0,disabled:e.disableNameField,error:e.employee_name_error||e.invalidCharacterError,helperText:e.invalidCharacterError?"Invalid characters in employee name":e.employee_name_error?"Employee name is required":""}),ye[r]&&q[r]&&t.jsx(Z,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:t.jsx(Ge,{sx:{maxHeight:200,overflow:"auto"},children:q[r].map((a,s)=>t.jsx(Ve,{button:!0,onClick:()=>Oe(r,a),children:`${a.employee_name}`},s))})})]}),t.jsx(p,{children:t.jsx(ie,{color:"primary",onClick:()=>ve(r),children:t.jsx(re,{})})})]},r))})]})}),t.jsx(te,{color:"primary",size:"small",onClick:xe,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:t.jsx(le,{})})]})]}),t.jsxs(h,{item:!0,xs:12,children:[t.jsx(v,{variant:"h6",children:"TRAINEE *:"}),t.jsxs(k,{sx:{position:"relative",backgroundColor:"#FAF9F6"},children:[c.rows&&t.jsx(v,{variant:"body2",color:"error",sx:{mt:1},children:c.rows}),t.jsx(ne,{component:Z,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:t.jsxs(oe,{children:[t.jsx(de,{children:t.jsxs(B,{children:[t.jsx(p,{children:"Sl. No"}),t.jsx(p,{sx:{pl:12},children:"Employee ID"}),t.jsx(p,{sx:{pl:12},children:"Employee Name"}),t.jsx(p,{children:"Actions"})]})}),t.jsx(me,{children:u.map((e,r)=>t.jsxs(B,{children:[t.jsx(p,{children:r+1}),t.jsx(p,{children:t.jsx(_,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id,onChange:a=>Te(r,a),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.error==="empty_field"?"Employee ID should not be empty":"",disabled:e.disableIDField})}),t.jsxs(p,{children:[t.jsx(_,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_name,onChange:a=>handleNameInputChange(r,a),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="invalid_name"?"Invalid characters. Only letters, spaces, and dots are allowed.":e.error==="name_mismatch"?"Incorrect name for the given Employee ID":e.error==="duplicate_name"?"Duplicate employee name":e.error==="empty_field"?"Employee Name should not be empty":"",disabled:e.disableNameField}),r===ue&&q.length>0&&t.jsx("div",{style:{position:"absolute",zIndex:1e3,width:"100%",backgroundColor:"#fff",border:"1px solid lightgrey",borderRadius:"4px",boxShadow:"0px 4px 8px rgba(0,0,0,0.2)",marginTop:"4px"},children:q.map((a,s)=>t.jsx("div",{style:{padding:"8px",backgroundColor:pe===s?"#f0f0f0":"#fff",cursor:"pointer"},onMouseEnter:()=>Se(s),onMouseLeave:De,onClick:()=>Ie(r,a),children:a.employee_name},a.employee_id))})]}),t.jsx(p,{children:t.jsx(ie,{"aria-label":"delete",onClick:()=>je(r),children:t.jsx(re,{})})})]},r))})]})}),t.jsx(k,{mt:2,children:t.jsx(te,{size:"small",color:"primary","aria-label":"add",onClick:be,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:t.jsx(le,{})})})]})]}),t.jsx(h,{item:!0,xs:12,children:t.jsx(se,{fullWidth:!0,margin:"normal",children:t.jsx(_,{label:"Description",multiline:!0,rows:4,value:J,onChange:ke})})}),t.jsx(h,{item:!0,xs:12,children:t.jsx(Le,{setCompressedImageBase64:F,compressedImageBase64:N})}),t.jsxs(h,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[t.jsx(h,{item:!0,xs:12,md:6,children:t.jsx(V,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:U,children:"Submit"})}),t.jsx(h,{item:!0,xs:12,md:6,children:t.jsx(V,{variant:"contained",color:"secondary",onClick:Be,fullWidth:!0,disabled:U,children:"Update"})})]})]})})})})})})};export{pa as default};
