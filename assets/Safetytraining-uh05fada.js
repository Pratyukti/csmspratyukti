import{h as ze,r as o,j as a,D as S}from"./index-gUoKkNxd.js";import"./Training4-C1urBjew.js";import{D as Y,F as ee,A as ae,I as Le}from"./Delete-DPTAQBJU.js";import{C as Ue}from"./Container-Bg8Dgr4V.js";import{B as q}from"./Box-BYukJ6PQ.js";import{C as $e,a as Je,D as Me}from"./CardContent-CmmJS602.js";import{G as u}from"./Grid-gLsvqBaq.js";import{T as g,F as re}from"./TextField-CxtPkCSH.js";import{B as H}from"./Button-CNiZY_Ay.js";import{T as j,P as Z,L as Ge,I as te}from"./IconButton-74Ti2Z6n.js";import{R as He,a as A,L as Ze}from"./RadioGroup-mZPBl_qQ.js";import{F as W}from"./FormControlLabel-CiMhkPdz.js";import{T as le,a as ie,b as se,c as B,d as p,e as ne}from"./TableRow-CG4wW5BX.js";import"./createSvgIcon-4eVnW2NG.js";import"./styled-CBr_OfpA.js";import"./dividerClasses-BJ5qgQ0n.js";const ua=()=>{const O=ze(e=>e.userInfo),[y,P]=o.useState(O.whitelevel_id),[z,D]=o.useState(new Date().toISOString().split("T")[0]),[v,L]=o.useState(""),[f,C]=o.useState("4"),[T,N]=o.useState(""),[oe,U]=o.useState(!1),[de,V]=o.useState([]),[Ve,me]=o.useState([]),[E,F]=o.useState(""),[$,_]=o.useState(!1),[J,R]=o.useState("");o.useState({option1:!1});const[h,x]=o.useState([]),[n,b]=o.useState([{employee_id:"",employee_name:"",manual:!1,disableNameField:!1}]),[k,M]=o.useState([]),[ce,X]=o.useState(null),[pe,ue]=o.useState(null),[he,w]=o.useState({}),[c,I]=o.useState({trainingDate:"",trainingId:"",whitelevelId:"",trainingType:"",trainingName:"",trainers:"",rows:"",image:"",about_the_training:""}),[Xe,ge]=o.useState(!1),ye=e=>/^[a-zA-Z\s.]*$/.test(e),fe=(e,t)=>{const r=e.map(d=>d.trainer_id),i=t.map(d=>d.trainee_id);return r.filter(d=>i.includes(d)).length>0},Q=async e=>{try{return(await S.post("/employee/name/",{employee_id:e,whitelevel_id:y})).data.employee_name||""}catch(t){return console.error("Error fetching employee name:",t),""}},_e=async e=>{try{return(await S.get(`/employee/search/?nameQuery=${e}`)).data||[]}catch(t){return console.error("Error fetching employee suggestions:",t),[]}},xe=()=>{if(h.some(r=>typeof r.employee_id=="string"&&r.employee_id.trim()===""||typeof r.employee_name=="string"&&r.employee_name.trim()==="")){alert("Please fill in all the fields before adding a new row.");const r=h.map(i=>({...i,error:typeof i.employee_id=="string"&&i.employee_id.trim()===""||typeof i.employee_name=="string"&&i.employee_name.trim()===""?"empty_field":i.error}));x(r),console.log("Updated rows after adding a row with empty fields:",r);return}const t=[...h,{employee_id:"",whitelevel_id:y,employee_name:"",error:null,disableNameField:!1}];x(t),console.log("Updated rows after adding a new row:",t)},be=()=>{if(n.length===0||n[n.length-1].employee_id&&(n[n.length-1].employee_name||n[n.length-1].name))b([...n,{employee_id:"",whitelevel_id:y,employee_name:"",name:"",error:"",manual:!1,employee_id_error:!1,employee_name_error:!1,disableNameField:!1,invalidCharacterError:!1}]);else{const t=[...n];n[n.length-1].employee_id||(t[n.length-1].employee_id_error=!0),n[n.length-1].employee_name||n[n.length-1].name||(t[n.length-1].employee_name_error=!0),b(t)}},je=e=>{const t=h.filter((r,i)=>i!==e);x(t),console.log("Updated rows after deleting a row:",t)},ve=e=>{const t=n.filter((r,i)=>i!==e);b(t),console.log("Updated rows after deleting a row:",t)},Te=async(e,t)=>{const{name:r,value:i}=t.target,l=[...h];if(l[e][r]=i.trim(),r==="employee_id")if(l.some((s,m)=>s.employee_id===i&&m!==e))l[e].error="duplicate",l[e].employee_name="",l[e].disableNameField=!0;else if(i.trim()!==""){const s=await Q(i);s?(l[e].employee_name=s,l[e].error=null,l[e].disableNameField=!0):(l[e].employee_name="",l[e].error="invalid",l[e].disableNameField=!0)}else l[e].employee_name="",l[e].error=null,l[e].disableNameField=!1;x(l),console.log("Updated rows after employee_id input change:",l)},K=async(e,t)=>{const{name:r,value:i}=t.target,l=[...n];if(r==="employee_name"||r==="name")if(ye(i))l[e].invalidCharacterError=!1;else{l[e].invalidCharacterError=!0,b(l);return}if(l[e][r]=i,r==="employee_id")if(l[e].employee_id_error=!1,l[e].error="",i==="0")l[e].employee_name="",l[e].manual=!0,l[e].disableNameField=!1;else{const d=l.some((s,m)=>s.employee_id===i&&m!==e);if(l[e].error=d?"duplicate":"",d)l[e].disableNameField=!0;else{const s=await Q(i);s?(l[e].employee_name=s,l[e].manual=!1,l[e].disableNameField=!0):(l[e].error="invalid",l[e].employee_name="",l[e].disableNameField=!0)}}else if(r==="employee_name")if(i.length>0)if(l.some((s,m)=>s.employee_name===i&&m!==e))l[e].error="duplicate",l[e].disableIDField=!0;else{const s=await _e(i);M(m=>({...m,[e]:s})),w(m=>({...m,[e]:!0})),l[e].disableIDField=!1}else M(d=>({...d,[e]:[]})),w(d=>({...d,[e]:!1}));else l[e].employee_name_error=!1,r==="name"&&n[e].employee_id==="0"&&(l[e].employee_name_error=!1,l[e].error="");b(l)},Ie=(e,t)=>{const r=[...h];r.some(l=>l.employee_id===t.employee_id&&l!==r[e])?(r[e].error="duplicate",r[e].disableNameField=!0):(r[e].employee_id=t.employee_id,r[e].employee_name=t.employee_name,r[e].error=null,r[e].disableNameField=!0),x(r),M([]),ue(null),console.log("Updated rows after suggestion click:",r)},we=e=>{X(e)},Se=()=>{X(null)},De=async e=>{if(e.target,!!v){_(!0),_(!0);try{const t=await S.post("/training/training-details/",{training_id:v,whitelevel_id:y}),r=t.data;r?(D(r.training_date),C(r.training_type),N(r.training_name),b(r.trainers.map(i=>({employee_id:i.employee_id,employee_name:i.trainer_name}))),x(r.trainees.map(i=>({employee_id:i.employee_id,employee_name:i.trainee_name}))),F(r.training_image),R(r.about_the_training)):alert("No SafetyTraining data found. Please check the reference number."),console.log("Fetched data:",t.data)}catch(t){console.error("Error fetching accident data:",t),I({fetch:"Failed to fetch accident data. Please try again."})}finally{_(!1)}}},Ce=e=>{P(e.target.value)},Ne=e=>{D(e.target.value)},Ee=e=>{const t=e.target.value;C(t),U(t==="1"),I({...c,trainingType:t===""?"Training Type is required":""})},Fe=e=>{const t=e.target.value,r=/^[A-Za-z\s]*$/;N(t),f==="1"&&(r.test(t)?I({...c,trainingName:""}):I({...c,trainingName:"Training Name must contain only alphabets and spaces"}))},Re=e=>{L(e.target.value)},ke=e=>{R(e.target.value)},qe=new Date().toISOString().split("T")[0],Ae=()=>{P(O.whitelevel_id),D(new Date().toISOString().split("T")[0]),L(""),C("4"),N(""),U(!1),V([]),me([]),F(""),R("")},We=async e=>{var l,d;e.preventDefault(),_(!0),ge(!0);let t=!0;const r={trainingDate:z?"":"Training Date is required",trainingId:v?"":"Training ID is required",whitelevelId:y?"":"Whitelevel ID is required",trainingType:f?"":"Training Type is required",trainingName:f==="1"&&!T?"Training Name is required":"",trainers:n.length===0?"At least one Trainer is required":"",trainees:h.length===0?"At least one Trainee is required":""};if(f==="1"&&(T?/^[A-Za-z\s]*$/.test(T)||(r.trainingName="Training Name must contain only alphabets and spaces",t=!1):(r.trainingName="Training Name is required",t=!1)),Object.keys(r).forEach(s=>{r[s]&&(t=!1)}),n.forEach((s,m)=>{s.employee_id!=="0"&&(!s.employee_id||!s.employee_name)&&(r[`trainer_${m}_name`]="Trainer name is required",t=!1)}),h.forEach((s,m)=>{s.employee_id_id!=="0"&&(!s.employee_id||!s.employee_name)&&(r[`trainee_${m}_name`]="Trainee name is required",t=!1)}),fe(de,h)&&(r.trainers="Trainer and Trainee employee codes should not be equal",r.rows="Trainer and Trainee employee codes should not be equal",t=!1),I(r),!t){_(!1);return}const i={training_id:v,training_date:z,whitelevel_id:y,training_type:f,training_image:E,about_the_training:J,training_name:f==="1"?T:null,trainers:n.map(({employee_id:s,whitelevel_id:m,employee_name:G})=>({trainer_id:s,whitelevel_id:m,trainer_name:G})),trainees:h.map(({employee_id:s,employee_name:m,whitelevel_id:G})=>({trainee_id:s,whitelevel_id:G,trainee_name:m}))};console.log("Submitting the following data:"),console.log(JSON.stringify(i,null,2));try{const s=await S.post("/training/start/",i);console.log("Success:",s.data),window.alert("Safety Training Form submitted successfully!"),Ae(),P(O.whitelevel_id),D(new Date().toISOString().split("T")[0]),L(""),C("4"),N(""),U(!1),V([]),x([]),F(""),R("")}catch(s){if(s.response){console.error(`HTTP error! Status: ${s.response.status}`);const m=JSON.stringify(s.response.data);console.error("Response body:",m),((d=(l=s.response.data)==null?void 0:l.training_id)==null?void 0:d[0])==="training with this training id already exists."?window.alert("Training ID already exists. Please use a different ID."):window.alert("Error submitting form. Please check the details and try again.")}else s.isAxiosError?(console.error("Axios error:",s.message),window.alert("An error occurred with the request. Please try again.")):s.name==="TypeError"?(console.error("Network error: Please check if the server is running and accessible."),window.alert("Network error: Please check if the server is running and accessible.")):(console.error("Error fetching data:",s.message),window.alert(`Error fetching data: ${s.message}`))}finally{_(!1)}},Be=async e=>{e.preventDefault(),_(!0);const t={training_id:v,training_type:f,training_name:T,whitelevel_id:y,image:E,about_the_training:J,training_image:E,trainers:n.map(({employee_id:r,whitelevel_id:i,employee_name:l})=>({employee_id:r,whitelevel_id:i,trainer_name:l})),trainees:h.map(({employee_id:r,employee_name:i,whitelevel_id:l})=>({employee_id:r,whitelevel_id:l,trainee_name:i}))};console.log(JSON.stringify(t,null,2));try{const r=await S.put("/training/training-details-update/",t);console.log("Updated Training:",r.data),alert("Updated Training:",r.data)}catch(r){console.error("Error:",r),I("An error occurred while updating the accident.")}finally{_(!1)}},Oe=(e,t)=>{const r=[...n];r.some((l,d)=>l.employee_name===t.employee_name&&d!==e)?(r[e].error="duplicate",r[e].employee_id_error=!0,r[e].employee_name=t.employee_name,r[e].employee_id="",r[e].disableIDField=!0):(r[e].employee_name=t.employee_name,r[e].employee_id=t.employee_id,r[e].manual=!1,r[e].error="",r[e].employee_id_error=!1,r[e].disableIDField=!1),w(l=>({...l,[e]:!1})),b(r)},Pe=e=>{setTimeout(()=>{w(t=>({...t,[e]:!1}))},200)};return a.jsx(Ue,{maxWidth:"xl",children:a.jsx(q,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:a.jsx("form",{onSubmit:We,children:a.jsx($e,{sx:{width:"100%",padding:3,boxShadow:3},children:a.jsx(Je,{children:a.jsxs(u,{container:!0,spacing:3,children:[a.jsx(u,{item:!0,xs:12,sm:5.5,children:a.jsx(g,{label:"Date",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:z,onChange:Ne,max:qe,error:!!c.trainingDate,helperText:c.trainingDate,required:!0})}),a.jsx(u,{item:!0,xs:12,sm:5.5,children:a.jsx(g,{label:"Reference Number",fullWidth:!0,value:v,onChange:Re,error:!!c.trainingId,helperText:c.trainingId})}),a.jsx(u,{item:!0,xs:12,sm:1,children:a.jsx(H,{variant:"contained",color:"secondary",onClick:De,fullWidth:!0,disabled:$,children:"ok"})}),a.jsxs(u,{item:!0,xs:12,children:[a.jsx(j,{variant:"h6",style:{display:"none"},children:"Whitelevel ID:"}),a.jsx(re,{fullWidth:!0,margin:"normal",style:{display:"none"},children:a.jsx(g,{style:{display:"none"},label:"Whitelevel ID",fullWidth:!0,value:y,onChange:Ce,error:!!c.whitelevelId,helperText:c.whitelevelId})})]}),a.jsxs(u,{item:!0,xs:12,children:[a.jsx(j,{variant:"h6",sx:{marginBottom:1},required:!0,children:"Training Type *:"}),a.jsxs(He,{row:!0,value:f,onChange:Ee,children:[a.jsx(W,{value:"4",control:a.jsx(A,{}),label:"Tool box Training"}),a.jsx(W,{value:"3",control:a.jsx(A,{}),label:"Job & Safety"}),a.jsx(W,{value:"2",control:a.jsx(A,{}),label:"Behavioural"}),a.jsx(W,{value:"1",control:a.jsx(A,{}),label:"Others"})]}),oe&&a.jsx(g,{label:"Name of Training",fullWidth:!0,value:T,onChange:Fe,error:!!c.trainingName,helperText:c.trainingName}),c.trainingType&&a.jsx(j,{variant:"body2",color:"error",sx:{mt:1},children:c.trainingType})]}),a.jsxs(u,{item:!0,xs:12,children:[a.jsx(Me,{sx:{marginBottom:3}}),a.jsx(j,{variant:"h6",children:"TRAINER *: (Enter 0 in case of Others)"}),a.jsxs(q,{sx:{position:"relative"},children:[a.jsx(le,{component:Z,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:a.jsxs(ie,{children:[a.jsx(se,{children:a.jsxs(B,{children:[a.jsx(p,{children:"Sl. No"}),a.jsx(p,{sx:{pl:12},children:"Employee ID"}),a.jsx(p,{sx:{pl:12},children:"Employee Name"}),a.jsx(p,{sx:{pl:2},children:"Actions"})]})}),a.jsx(ne,{children:n.map((e,t)=>a.jsxs(B,{children:[a.jsx(p,{children:t+1}),a.jsx(p,{children:a.jsx(g,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id!==0?e.employee_id:"",onChange:r=>K(t,r),fullWidth:!0,required:!0,error:!!e.error||e.employee_id_error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.employee_id_error?"Employee ID is required":"",disabled:e.disableIDField,onFocus:()=>w(r=>({...r,[t]:!1}))})}),a.jsxs(p,{children:[a.jsx(g,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_id==="0"?e.name||e.employee_name:e.employee_name||"",onChange:r=>K(t,r),onBlur:()=>Pe(t),fullWidth:!0,required:!0,disabled:e.disableNameField,error:e.employee_name_error||e.invalidCharacterError,helperText:e.invalidCharacterError?"Invalid characters in employee name":e.employee_name_error?"Employee name is required":""}),he[t]&&k[t]&&a.jsx(Z,{sx:{position:"absolute",zIndex:1,maxWidth:"300px"},children:a.jsx(Ge,{sx:{maxHeight:200,overflow:"auto"},children:k[t].map((r,i)=>a.jsx(Ze,{button:!0,onClick:()=>Oe(t,r),children:`${r.employee_name}`},i))})})]}),a.jsx(p,{children:a.jsx(te,{color:"primary",onClick:()=>ve(t),children:a.jsx(Y,{})})})]},t))})]})}),a.jsx(ee,{color:"primary",size:"small",onClick:be,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:a.jsx(ae,{})}),c.trainers&&a.jsx(j,{variant:"body2",color:"error",sx:{mt:1},children:c.trainers})]})]}),a.jsxs(u,{item:!0,xs:12,children:[a.jsx(j,{variant:"h6",children:"TRAINEE *:"}),a.jsxs(q,{sx:{position:"relative",backgroundColor:"#FAF9F6"},children:[c.rows&&a.jsx(j,{variant:"body2",color:"error",sx:{mt:1},children:c.rows}),a.jsx(le,{component:Z,sx:{border:"1px solid lightgrey",borderRadius:"8px",boxShadow:"none"},children:a.jsxs(ie,{children:[a.jsx(se,{children:a.jsxs(B,{children:[a.jsx(p,{children:"Sl. No"}),a.jsx(p,{sx:{pl:12},children:"Employee ID"}),a.jsx(p,{sx:{pl:12},children:"Employee Name"}),a.jsx(p,{children:"Actions"})]})}),a.jsx(ne,{children:h.map((e,t)=>a.jsxs(B,{children:[a.jsx(p,{children:t+1}),a.jsx(p,{children:a.jsx(g,{variant:"outlined",size:"small",name:"employee_id",value:e.employee_id,onChange:r=>Te(t,r),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="duplicate"?"Duplicate employee ID":e.error==="invalid"?"Employee does not exist":e.error==="empty_field"?"Employee ID should not be empty":"",disabled:e.disableIDField})}),a.jsxs(p,{children:[a.jsx(g,{variant:"outlined",size:"small",name:"employee_name",value:e.employee_name,onChange:r=>handleNameInputChange(t,r),fullWidth:!0,required:!0,error:!!e.error,helperText:e.error==="invalid_name"?"Invalid characters. Only letters, spaces, and dots are allowed.":e.error==="name_mismatch"?"Incorrect name for the given Employee ID":e.error==="duplicate_name"?"Duplicate employee name":e.error==="empty_field"?"Employee Name should not be empty":"",disabled:e.disableNameField}),t===pe&&k.length>0&&a.jsx("div",{style:{position:"absolute",zIndex:1e3,width:"100%",backgroundColor:"#fff",border:"1px solid lightgrey",borderRadius:"4px",boxShadow:"0px 4px 8px rgba(0,0,0,0.2)",marginTop:"4px"},children:k.map((r,i)=>a.jsx("div",{style:{padding:"8px",backgroundColor:ce===i?"#f0f0f0":"#fff",cursor:"pointer"},onMouseEnter:()=>we(i),onMouseLeave:Se,onClick:()=>Ie(t,r),children:r.employee_name},r.employee_id))})]}),a.jsx(p,{children:a.jsx(te,{"aria-label":"delete",onClick:()=>je(t),children:a.jsx(Y,{})})})]},t))})]})}),a.jsx(q,{mt:2,children:a.jsx(ee,{size:"small",color:"primary","aria-label":"add",onClick:xe,sx:{position:"absolute",bottom:-18,left:"49%",transform:"translateX(-50%)",boxShadow:"none",zIndex:1},children:a.jsx(ae,{})})})]})]}),a.jsx(u,{item:!0,xs:12,children:a.jsx(re,{fullWidth:!0,margin:"normal",children:a.jsx(g,{label:"Description",multiline:!0,rows:4,value:J,onChange:ke})})}),a.jsx(u,{item:!0,xs:12,children:a.jsx(Le,{setCompressedImageBase64:F,compressedImageBase64:E})}),a.jsxs(u,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(H,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:$,children:"Submit"})}),a.jsx(u,{item:!0,xs:12,md:6,children:a.jsx(H,{variant:"contained",color:"secondary",onClick:Be,fullWidth:!0,disabled:$,children:"Update"})})]})]})})})})})})};export{ua as default};
