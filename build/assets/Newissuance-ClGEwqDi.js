import{h as te,r as i,j as e,D}from"./index-BOrs9Cmb.js";import{T as ae,I as ne}from"./Training4-Cu7BmkG1.js";import{B as p}from"./Box-DpLwRB0J.js";import{B as re,T as l}from"./IconButton-SZuj0VD6.js";import{C as ie}from"./CircularProgress-C7CNfSwI.js";import{C as oe,a as le,D as V}from"./CardContent-Cr9D6Czc.js";import{G as g}from"./Grid-DEtsKlCu.js";import{T as W,F as P}from"./TextField-D9XwQG_q.js";import{B as q}from"./Button-Be_xG8_1.js";import{F as x}from"./FormControlLabel-DOo0s4Nv.js";import{C as _}from"./Checkbox-KMrz2jOt.js";import"./createSvgIcon-CPmCxJRd.js";import"./TableRow-BtW6bwTe.js";import"./dividerClasses-BjxhlnSS.js";import"./styled-D9bX19Hj.js";const Pe=()=>{const Y=te(t=>t.userInfo),[c,w]=i.useState({TOOLS:!1,PPE:!1,DRESS:!1}),[T,U]=i.useState([]),[C,z]=i.useState([]),[O,$]=i.useState([]),[y,I]=i.useState(new Date().toISOString().split("T")[0]),[f,G]=i.useState(""),[R,ce]=i.useState(Y.whitelevel_id),[v,L]=i.useState(""),[j,B]=i.useState([]),[o,S]=i.useState({}),[E,b]=i.useState(!1),[A,N]=i.useState(""),[m,M]=i.useState({tools:[],ppes:[],dresses:[]});i.useState({option1:!1}),i.useState({}),i.useEffect(()=>{(async()=>{try{const s=(await D.get("/item/getAll/")).data,a=s.filter(h=>h.item_type.item_type_name==="Tool"),u=s.filter(h=>h.item_type.item_type_name==="PPE"),d=s.filter(h=>h.item_type.item_type_name==="Dress");M({tools:a,ppes:u,dresses:d})}catch(n){console.error("Error fetching items:",n)}})()},[]);const Z=async t=>{if(t.target,!f){alert("Issuance ID is required to fetch details.");return}try{const s=(await D.post("/item/get-details/",{issue_id:f,whitelevel_id:R})).data;if(s){I(s.new_issuance.issuance_date);const a={TOOLS:s.issued_things.some(r=>r.item_type_id==="1"),PPE:s.issued_things.some(r=>r.item_type_id==="2"),DRESS:s.issued_things.some(r=>r.item_type_id==="3")};w(a);const u=s.issued_things.filter(r=>r.item_type_id==="1"),d=s.issued_things.filter(r=>r.item_type_id==="2"),h=s.issued_things.filter(r=>r.item_type_id==="3");M({tools:u,ppes:d,dresses:h}),B(s.issued_to_employees.map(r=>({employee_id:r.employee,employee_name:r.employee_name}))),L(s.new_issuance.newIssuance_image),N(s.new_issuance.about_the_newissuance)}else alert("No issuance data found. Please check the reference number.")}catch(n){console.error("Error fetching issuance data:",n),S({fetch:"Failed to fetch issuance data. Please try again."})}},H=async t=>{t.preventDefault(),b(!0);const n=[...C.map(a=>({item:a.item})),...T.map(a=>({item:a.item})),...O.map(a=>({item:a.item}))],s={issuance_id:f,whitelevel_id:R,issuance_date:y,newIssuance_image:v,about_the_newissuance:A,issued_things:n,issued_to_employees:j.map(({employee_id:a})=>({employee:a}))};try{const a=await D.put("item/newissuance-update/",s);console.log("Updated NewIssuance:",a.data),alert("Updated NewIssuance:",a.data)}catch(a){console.error("Error:",a),S("An error occurred while updating the accident.")}finally{b(!1)}},F=t=>{const{name:n,checked:s}=t.target;w(a=>({...a,[n]:s}))},k=(t,n)=>{const{name:s,checked:a}=t.target,u=(d,h,r)=>r?[...d,{item:h}]:d.filter(se=>se.item!==h);n==="TOOLS"&&z(d=>u(d,s,a)),n==="PPE"&&U(d=>u(d,s,a)),n==="DRESS"&&$(d=>u(d,s,a))},J=t=>{B(t)},K=t=>{N(t.target.value)},Q=()=>{let t={};y||(t.issuance_date="Issuance date is required");const n=/^[A-Za-z0-9/-]+$/;return f?f.length<3||f.length>21?t.issuance_id="Reference number must be between 3 and 21 characters":n.test(f)||(t.issuance_id="Reference number can only contain letters, numbers, hyphens, and slashes"):t.issuance_id="Reference number is required",c.TOOLS&&C.length===0&&(t.tools="At least one tool must be selected"),c.PPE&&T.length===0&&(t.ppe="At least one PPE must be selected"),c.DRESS&&O.length===0&&(t.dress="At least one dress must be selected"),j.length===0?t.employees="Employee details are required":j.forEach(({employee_id:s,employee_name:a},u)=>{(!s||!a)&&(t.employees=`Employee ID and Name cannot be empty for entry #${u+1}`)}),!c.TOOLS&&!c.PPE&&!c.DRESS&&(t.items="At least one item category must be selected"),S(t),Object.keys(t).length===0},X=()=>{w({TOOLS:!1,PPE:!1,DRESS:!1}),U([]),z([]),$([]),I(new Date().toISOString().split("T")[0]),G(""),L(""),S({}),N(""),B([])},ee=async()=>{if(!Q())return;b(!0);const t=[...C.map(s=>({item:s.item})),...T.map(s=>({item:s.item})),...O.map(s=>({item:s.item}))],n={issuance:{issuance_id:f,white_level_id:R,issuance_date:y,newIssuance_image:v,about_the_newissuance:A},issued_things:t,employees:j.map(({employee_id:s,employee_name:a,whitelevel_id:u})=>({employee_id:s,employee_name:a,whitelevel_id:u}))};try{const a=(await D.post("/item/new/",n)).data.message;console.log("Data submitted successfully:",a),alert("New Issuance Successfully submitted."),X()}catch(s){console.error("Error submitting data:",s),alert(`Error submitting data: ${s.message}`)}finally{b(!1)}};return e.jsxs(p,{className:"section",sx:{display:"flex",justifyContent:"center",padding:4},children:[e.jsx(re,{sx:{color:"#fff",zIndex:t=>t.zIndex.drawer+1},open:E,children:e.jsx(ie,{color:"inherit"})}),e.jsx(oe,{sx:{width:"100%",padding:3},children:e.jsxs(le,{children:[e.jsxs(g,{container:!0,spacing:2,marginBottom:3,children:[e.jsx(g,{item:!0,xs:12,sm:5.5,children:e.jsx(W,{label:"Date*",type:"date",fullWidth:!0,InputLabelProps:{shrink:!0},inputProps:{max:new Date().toISOString().split("T")[0]},value:y,onChange:t=>I(t.target.value),error:!!o.issuance_date,helperText:o.issuance_date})}),e.jsx(g,{item:!0,xs:12,sm:5.5,children:e.jsx(W,{label:"Reference Number*",fullWidth:!0,value:f,onChange:t=>G(t.target.value),error:!!o.issuance_id,helperText:o.issuance_id})}),e.jsx(g,{item:!0,xs:12,sm:1,sx:{marginTop:"10px"},kk:!0,children:e.jsx(q,{variant:"contained",color:"secondary",onClick:Z,fullWidth:!0,disabled:E,children:"ok"})})]}),e.jsx(V,{sx:{marginBottom:3}}),e.jsx(l,{variant:"h6",children:"Items*:"}),o.items&&e.jsx(l,{color:"error",children:o.items}),e.jsx(x,{control:e.jsx(_,{checked:c.TOOLS,onChange:F,name:"TOOLS"}),label:"TOOLS"}),e.jsx(x,{control:e.jsx(_,{checked:c.PPE,onChange:F,name:"PPE"}),label:"PPE"}),e.jsx(x,{control:e.jsx(_,{checked:c.DRESS,onChange:F,name:"DRESS"}),label:"DRESS"}),c.TOOLS&&e.jsxs(p,{marginBottom:3,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(l,{variant:"h6",children:"TOOLS"}),((m==null?void 0:m.tools)??[]).length>0?e.jsx(p,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((t,n)=>e.jsx(p,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:n<3?2:0,marginBottom:2,children:m.tools.slice(n*10,(n+1)*10).map(s=>e.jsx(x,{control:e.jsx(_,{onChange:a=>k(a,"TOOLS"),name:s.item_id}),label:s.item_name},s.item_id))},n))}):e.jsx(l,{children:"Loading tools..."})]}),o.tools&&e.jsx(l,{color:"error",children:o.tools})]}),c.PPE&&e.jsxs(p,{marginBottom:3,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(l,{variant:"h6",children:"PPE"}),((m==null?void 0:m.ppes)??[]).length>0?e.jsx(p,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((t,n)=>e.jsx(p,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:n<3?2:0,marginBottom:2,children:m.ppes.slice(n*10,(n+1)*10).map(s=>e.jsx(x,{control:e.jsx(_,{onChange:a=>k(a,"PPE"),name:s.item_id}),label:s.item_name},s.item))},n))}):e.jsx(l,{children:"Loading PPE..."})]}),o.ppe&&e.jsx(l,{color:"error",children:o.ppe})]}),c.DRESS&&e.jsxs(p,{marginBottom:3,children:[e.jsxs(P,{component:"fieldset",children:[e.jsx(l,{variant:"h6",children:"DRESS"}),((m==null?void 0:m.dresses)??[]).length>0?e.jsx(p,{display:"flex",justifyContent:"space-between",children:[...Array(4)].map((t,n)=>e.jsx(p,{display:"flex",flexDirection:"column",flex:"1 0 22%",marginRight:n<3?2:0,marginBottom:2,children:m.dresses.slice(n*10,(n+1)*10).map(s=>e.jsx(x,{control:e.jsx(_,{onChange:a=>k(a,"DRESS"),name:s.item_id}),label:s.item_name},s.item))},n))}):e.jsx(l,{children:"Loading dresses..."})]}),o.dress&&e.jsx(l,{color:"error",children:o.dress})]}),e.jsx(V,{sx:{marginBottom:3}}),e.jsxs(p,{marginBottom:3,children:[e.jsx(l,{variant:"h6",children:"EMPLOYEE DETAILS*:"}),e.jsx(ae,{onChange:J,initialData:j}),o.employees&&e.jsx(l,{color:"error",children:o.employees})]}),e.jsx(g,{item:!0,xs:12,children:e.jsx(P,{fullWidth:!0,margin:"normal",children:e.jsx(W,{label:"Description....",multiline:!0,rows:4,value:A,onChange:K})})}),e.jsx(g,{item:!0,xs:12,children:e.jsx(ne,{setCompressedImageBase64:L,compressedImageBase64:v})}),e.jsxs(g,{container:!0,spacing:2,sx:{marginTop:"20px"},children:[e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(q,{variant:"contained",color:"primary",type:"submit",fullWidth:!0,disabled:E,onClick:ee,children:"Submit"})}),e.jsx(g,{item:!0,xs:12,md:6,children:e.jsx(q,{variant:"contained",color:"secondary",onClick:H,fullWidth:!0,disabled:E,children:"Update NewIssuance"})})]})]})})]})};export{Pe as default};
